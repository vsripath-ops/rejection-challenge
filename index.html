<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rejection Challenge</title>
  <meta name="description" content="A public rejection practice game: deal yourself a real-life ask, log the result, build streaks, earn XP, unlock badges, export your log. No login." />

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%23120b08'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-family='Arial' font-size='26' font-weight='800' fill='%23fff6f0'%3ERC%3C/text%3E%3C/svg%3E">

  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#120b08;
      --card:#1b120f;
      --muted:#d7bfb2;
      --text:#fff6f0;

      --accent:#ff7a59;   /* coral */
      --accent2:#ffb86b;  /* amber */
      --good:#4fd8a2;     /* mint */
      --bad:#ff5a7a;      /* pink-red */

      --border: rgba(255,246,240,.12);
      --shadow: 0 18px 55px rgba(0,0,0,.44);

      --radius:20px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(255,122,89,.34), transparent 60%),
        radial-gradient(900px 520px at 100% 8%, rgba(255,184,107,.22), transparent 55%),
        radial-gradient(700px 420px at 40% 120%, rgba(79,216,162,.12), transparent 60%),
        var(--bg);
      min-height:100vh;
    }

    a{color:inherit; text-decoration:none}

    .wrap{max-width:1120px; margin:0 auto; padding:26px 16px 70px}
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      margin-bottom:14px;
    }
    @media (max-width: 980px){ header{flex-direction:column} }

    .brand{display:flex; flex-direction:column; gap:8px}
    .title{display:flex; align-items:center; gap:10px; flex-wrap:wrap; font-size:22px; font-weight:1000; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:14px; line-height:1.4; max-width:80ch}

    .pill{
      font-family:var(--mono);
      font-size:12px;
      border:1px solid rgba(255,246,240,.18);
      padding:4px 8px;
      border-radius:999px;
      background:rgba(255,246,240,.06);
      color:rgba(255,246,240,.92);
      white-space:nowrap;
    }

    .grid{display:grid; grid-template-columns:1.25fr .75fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(27,18,15,.92), rgba(27,18,15,.72));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
    }
    .card h2{margin:0 0 10px; font-size:15px; letter-spacing:.2px}

    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1 1 auto}

    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}

    select, input[type="range"], input[type="text"], textarea{
      width:100%;
      background:rgba(255,246,240,.06);
      border:1px solid rgba(255,246,240,.14);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    select:focus, input[type="text"]:focus, textarea:focus{
      border-color: rgba(255,184,107,.40);
      box-shadow: 0 0 0 3px rgba(255,184,107,.12);
    }
    textarea{min-height:88px; resize:vertical}

    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:10px 12px;
      border-radius:14px;
      font-weight:1000;
      color:var(--text);
      background:rgba(255,246,240,.08);
      border:1px solid rgba(255,246,240,.16);
      transition:transform .06s ease, filter .15s ease, background .15s ease;
      user-select:none;
      text-align:center;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.small{padding:8px 10px; font-size:13px; box-shadow:none}
    .btn.ghost{background:rgba(255,246,240,.06); box-shadow:none}
    .btn.primary{
      background: linear-gradient(90deg, rgba(255,122,89,.98), rgba(255,184,107,.86));
      border-color: rgba(255,184,107,.30);
    }
    .btn.good{
      background: linear-gradient(90deg, rgba(79,216,162,.92), rgba(79,216,162,.62));
      border-color: rgba(79,216,162,.40);
    }
    .btn.bad{
      background: linear-gradient(90deg, rgba(255,90,122,.95), rgba(255,90,122,.62));
      border-color: rgba(255,90,122,.42);
    }

    .muted{color:var(--muted)}
    .kbd{
      font-family:var(--mono);
      border:1px solid rgba(255,246,240,.18);
      background:rgba(255,246,240,.07);
      padding:2px 6px;
      border-radius:8px;
    }

    .tag{
      border:1px solid rgba(255,246,240,.14);
      background:rgba(255,246,240,.06);
      padding:3px 8px;
      border-radius:999px;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,246,240,.92);
    }

    .challenge{
      border:1px solid rgba(255,246,240,.14);
      border-radius:18px;
      padding:14px;
      background:
        radial-gradient(700px 260px at 0% 0%, rgba(255,122,89,.18), transparent 60%),
        radial-gradient(700px 260px at 100% 0%, rgba(255,184,107,.14), transparent 60%),
        rgba(12,8,7,.55);
    }
    .challenge .headline{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .challenge .meta{display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-size:12px}
    .challenge .text{font-size:19px; font-weight:1000; margin:10px 0 6px; line-height:1.25}

    .footer{
      margin-top:12px;
      color:var(--muted);
      font-size:12px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Hero */
    .hero{
      padding:18px 16px;
      border-radius: var(--radius);
      border:1px solid rgba(255,246,240,.12);
      background:
        radial-gradient(1000px 420px at 0% 0%, rgba(255,122,89,.22), transparent 60%),
        radial-gradient(1000px 420px at 100% 0%, rgba(255,184,107,.18), transparent 60%),
        rgba(27,18,15,.55);
      box-shadow: var(--shadow);
    }
    .hero h1{margin:0; font-size:34px; line-height:1.08; letter-spacing:.2px}
    .hero p{margin:10px 0 0; color:var(--muted); max-width:78ch; line-height:1.55}
    .ctaRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}

    .progressWrap{margin-top:12px; display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .progressBar{
      flex:1 1 260px;
      height:11px;
      border-radius:999px;
      background:rgba(255,246,240,.07);
      border:1px solid rgba(255,246,240,.12);
      overflow:hidden;
    }
    .progressBar > div{
      height:100%;
      width:0%;
      background:linear-gradient(90deg, rgba(255,122,89,.96), rgba(255,184,107,.88));
    }
    .progressText{font-size:12px; color:var(--muted); font-family:var(--mono)}

    /* Collapsible helpers */
    details.helper{
      margin-top:12px;
      border:1px solid rgba(255,246,240,.12);
      background:rgba(255,246,240,.05);
      border-radius:16px;
      padding:12px;
    }
    details.helper summary{
      cursor:pointer;
      font-weight:1000;
      list-style:none;
    }
    details.helper summary::-webkit-details-marker{display:none}
    details.helper .inside{margin-top:10px; color:var(--muted); line-height:1.55}

    .helperGrid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 980px){ .helperGrid{grid-template-columns:1fr} }
    .smallList{margin:0; padding-left:18px; color:var(--muted); line-height:1.55}

    /* Plan */
    .section{margin-top:14px}
    .planGrid{display:grid; grid-template-columns: repeat(3, 1fr); gap:10px}
    @media (max-width: 980px){ .planGrid{grid-template-columns:1fr 1fr} }
    @media (max-width: 620px){ .planGrid{grid-template-columns:1fr} }

    .dayCard{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,246,240,.12);
      background:rgba(255,246,240,.05);
    }
    .dayTop{display:flex; justify-content:space-between; align-items:flex-start; gap:10px}
    .dayTitle{font-weight:1000; letter-spacing:.2px}
    .dayMeta{display:flex; gap:6px; flex-wrap:wrap; margin-top:8px}
    .dayText{margin-top:8px; line-height:1.35}
    .dayActions{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    /* Stats */
    .statgrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width: 520px){ .statgrid{grid-template-columns:1fr} }
    .stat{
      padding:12px;
      border-radius:14px;
      background:rgba(255,246,240,.05);
      border:1px solid rgba(255,246,240,.12);
    }
    .stat .k{font-size:11px; color:var(--muted)}
    .stat .v{font-size:20px; font-weight:1000; margin-top:4px}

    /* Quests / badges */
    .q{
      padding:12px;
      border-radius:14px;
      background:rgba(255,246,240,.05);
      border:1px solid rgba(255,246,240,.12);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .q .t{font-weight:1000; line-height:1.25}
    .q .d{color:var(--muted); font-size:12px; line-height:1.35; margin-top:4px}

    .badge{
      border:1px solid rgba(255,246,240,.14);
      background:rgba(255,246,240,.06);
      padding:6px 10px;
      border-radius:999px;
      font-family:var(--mono);
      font-size:12px;
    }
    .badge.locked{opacity:.45}

    /* Table */
    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,246,240,.10); vertical-align:top}
    th{color:var(--muted); font-weight:900; text-align:left; font-size:12px}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(27,18,15,.92);
      border:1px solid rgba(255,246,240,.14);
      padding:10px 12px; border-radius:999px;
      box-shadow:var(--shadow);
      display:none;
      font-size:13px;
      z-index:9999;
      max-width:min(92vw, 720px);
      text-align:center;
    }

    /* Share card */
    .shareCard{
      border-radius:18px;
      border:1px solid rgba(255,246,240,.14);
      background:
        radial-gradient(900px 400px at 0% 0%, rgba(255,122,89,.22), transparent 60%),
        radial-gradient(900px 400px at 100% 0%, rgba(255,184,107,.18), transparent 60%),
        rgba(27,18,15,.55);
      padding:14px;
    }
    .shareCard .top{display:flex; justify-content:space-between; gap:10px; align-items:flex-start; flex-wrap:wrap}
    .shareCard .app{font-weight:1000; letter-spacing:.2px; display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .shareCard .big{font-size:18px; font-weight:1000; margin:10px 0 8px; line-height:1.25}
    .shareCard .small{font-size:12px; color:var(--muted); display:flex; gap:8px; flex-wrap:wrap; align-items:center}

    @media print{
      header, .grid, #tracker { display:none !important; }
      body{ background:#fff !important; color:#000 !important; }
      .card, .hero, .dayCard{ box-shadow:none !important; background:#fff !important; color:#000 !important; border:1px solid #ddd !important; }
      .muted{ color:#333 !important; }
      .tag, .pill, .badge{ border:1px solid #ddd !important; background:#fff !important; color:#000 !important; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="title">
          Rejection Challenge
          <span class="pill">public</span>
          <span class="pill">no login</span>
          <span class="pill">playable</span>
        </div>
        <div class="sub">
          Deal yourself one real-life ask. Do it in person. Log the result. Repeat.
        </div>
      </div>
      <div class="row" style="justify-content:flex-end; min-width:280px">
        <button class="btn small" id="resetBtn" title="Clears logs + streak + game">Reset</button>
        <button class="btn small" id="exportBtn" title="Download CSV of your logs">Export</button>
        <button class="btn small" id="shareAppBtn" title="Share the app">Share</button>
      </div>
    </header>

    <section class="hero" id="top">
      <div class="title" style="font-size:14px; font-weight:1000; letter-spacing:.2px; margin-bottom:6px;">
        30 days · in person · one rep a day
      </div>

      <h1>Get comfortable hearing “no”.</h1>
      <p>
        Not therapy. Not a lecture. Just reps.
        You’ll be surprised how fast the fear drops once you start.
      </p>

      <div class="progressWrap">
        <div class="progressBar" aria-label="30-day progress">
          <div id="heroProgressFill"></div>
        </div>
        <div class="progressText"><span id="heroProgressText">0/30</span></div>
      </div>

      <div class="ctaRow">
        <button class="btn primary" id="startTodayBtn" type="button">Start today</button>
        <a class="btn ghost" href="#tracker">Open tracker</a>
        <a class="btn ghost" href="#plan">See plan</a>
        <button class="btn ghost" id="printPlanBtn" type="button">Print</button>
      </div>

      <details class="helper">
        <summary>Quick help (optional)</summary>
        <div class="inside helperGrid">
          <div>
            <div style="font-weight:1000; margin-bottom:6px">Rules (tiny)</div>
            <ul class="smallList">
              <li>In person only.</li>
              <li>Be polite. Keep it short.</li>
              <li>If they say no, you stop.</li>
              <li>Stay safe + legal.</li>
            </ul>
          </div>
          <div>
            <div style="font-weight:1000; margin-bottom:6px">If you freeze</div>
            <ul class="smallList">
              <li>Smile. One sentence.</li>
              <li>“No worries—thanks anyway.”</li>
              <li>Log it. That’s the win.</li>
            </ul>
          </div>
        </div>
      </details>
    </section>

    <!-- Plan -->
    <section class="section" id="plan">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <h2 style="margin:0">30-day plan</h2>
            <div class="muted" style="margin-top:6px; line-height:1.5">
              Tap Start on any day to load a prompt into the tracker.
            </div>
          </div>
          <div class="row" style="flex:0 0 auto">
            <button class="btn small" id="markAllDoneBtn" type="button">Mark all</button>
            <button class="btn small" id="clearPlanBtn" type="button">Clear</button>
          </div>
        </div>

        <div class="progressWrap" style="margin-top:10px">
          <div class="progressBar">
            <div id="planProgressFill"></div>
          </div>
          <div class="progressText" id="planProgressText">0/30</div>
        </div>

        <div class="planGrid" id="planGrid" style="margin-top:12px"></div>
      </div>
    </section>

    <div id="tracker"></div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>Tracker</h2>

        <div class="row">
          <div style="min-width:220px">
            <label for="pack">Pack</label>
            <select id="pack">
              <option value="all" selected>Mixed</option>
              <option value="beginner">Beginner</option>
              <option value="networking">Networking</option>
              <option value="wholesome">Chaos (wholesome)</option>
              <option value="negotiation">Negotiation</option>
            </select>
          </div>

          <div style="min-width:220px">
            <label for="category">Category</label>
            <select id="category">
              <option value="any">Any</option>
              <option value="food">Food</option>
              <option value="social">Social</option>
              <option value="help">Help</option>
              <option value="negotiation">Negotiate</option>
              <option value="weird">Weird</option>
              <option value="career">Career</option>
            </select>
          </div>

          <div style="min-width:220px">
            <label for="difficulty">Heat: <span id="diffLabel" class="pill">3</span></label>
            <input id="difficulty" type="range" min="1" max="5" value="3" />
          </div>

          <div style="min-width:220px">
            <label for="timebox">Timer</label>
            <select id="timebox">
              <option value="0">Off</option>
              <option value="5">5 min</option>
              <option value="10">10 min</option>
              <option value="15" selected>15 min</option>
              <option value="30">30 min</option>
            </select>
          </div>
        </div>

        <div class="challenge" style="margin-top:12px">
          <div class="headline">
            <div class="meta">
              <span class="tag" id="tagPack">pack: all</span>
              <span class="tag" id="tagCat">any</span>
              <span class="tag" id="tagDiff">heat: 3</span>
              <span class="tag" id="tagMode">mode: random</span>
            </div>
            <div class="row" style="flex:0 0 auto">
              <button class="btn small" id="copyLinkBtn">Copy link</button>
              <button class="btn small" id="todayBtn" title="Same prompt for today">Today</button>
              <button class="btn primary" id="newBtn">Deal me one</button>
            </div>
          </div>
          <div class="text" id="challengeText">Hit “Deal me one” to start.</div>
          <div class="muted" id="timerText" style="margin-top:6px"></div>
        </div>

        <div style="margin-top:12px">
          <div class="row">
            <div style="min-width:220px">
              <label for="where">Where (optional)</label>
              <input id="where" type="text" placeholder="coffee shop, campus, gym" />
            </div>
            <div style="min-width:220px">
              <label for="who">Who (optional)</label>
              <input id="who" type="text" placeholder="barista, stranger, classmate" />
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <div style="min-width:220px">
              <label for="before">Before: <span id="beforeLabel" class="pill">3</span></label>
              <input id="before" type="range" min="1" max="5" value="3" />
            </div>
            <div style="min-width:220px">
              <label for="after">After: <span id="afterLabel" class="pill">3</span></label>
              <input id="after" type="range" min="1" max="5" value="3" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="note">Note (optional)</label>
            <textarea id="note" placeholder="Anything funny? Anything learned?"></textarea>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn good" id="acceptedBtn">Got a yes</button>
            <button class="btn bad" id="rejectedBtn">Got a no</button>
          </div>

          <div class="footer">
            <div>Short + polite wins.</div>
            <div>Keys: <span class="kbd">G</span> deal · <span class="kbd">T</span> today · <span class="kbd">R</span> log no</div>
          </div>
        </div>

        <details class="helper">
          <summary>Little scripts (optional)</summary>
          <div class="inside">
            <ul class="smallList">
              <li><b>Coffee chat:</b> “Quick one—would you be up for a 10-minute coffee sometime? Totally fine if not.”</li>
              <li><b>Feedback:</b> “Can I get one quick note—what would you improve?”</li>
              <li><b>After a no:</b> “All good—thanks anyway. Anything I should do differently next time?”</li>
            </ul>
          </div>
        </details>

        <!-- Share card -->
        <div style="margin-top:14px" class="card">
          <h2>Share card</h2>
          <div class="muted" style="font-size:12px; margin-top:-6px">Post a prompt to friends.</div>

          <div id="shareCard" class="shareCard" style="margin-top:10px">
            <div class="top">
              <div class="app">Rejection Challenge <span class="pill" id="shareStamp">today</span></div>
              <div class="small">
                <span class="tag" id="sharePack">pack: all</span>
                <span class="tag" id="shareCat">any</span>
                <span class="tag" id="shareDiff">d3</span>
              </div>
            </div>
            <div class="big" id="shareText">Deal a prompt to fill this.</div>
            <div class="small">
              <span class="tag">be polite</span>
              <span class="tag">accept no</span>
              <span class="tag">in person</span>
            </div>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn small" id="copyImageBtn">Copy image</button>
            <button class="btn small" id="downloadImageBtn">Download</button>
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>Stats</h2>

        <div class="statgrid">
          <div class="stat">
            <div class="k">No streak (days)</div>
            <div class="v" id="streak">0</div>
            <div class="muted" style="font-size:11px; margin-top:6px" id="streakHint">Log one “no” today.</div>
          </div>

          <div class="stat">
            <div class="k">Level</div>
            <div class="v"><span id="level">1</span></div>
            <div class="muted" style="font-size:11px; margin-top:6px"><span id="xp">0</span> XP</div>
          </div>

          <div class="stat">
            <div class="k">Shields</div>
            <div class="v"><span id="shields">0</span></div>
            <div class="muted" style="font-size:11px; margin-top:6px">One save per week.</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Daily quests</h2>
          <div class="muted" style="font-size:12px; margin-top:-6px">Tiny bonuses. Totally optional.</div>
          <div id="quests" style="margin-top:10px; display:grid; gap:10px"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Badges</h2>
          <div class="muted" style="font-size:12px; margin-top:-6px">Earned on this device.</div>
          <div id="badges" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap"></div>
        </div>

        <div class="card" style="margin-top:12px">
          <h2>Weekly boss</h2>
          <div class="muted" style="font-size:12px; margin-top:-6px">One bigger ask. Bigger XP.</div>
          <div class="challenge" style="margin-top:10px">
            <div class="meta">
              <span class="tag" id="bossWeekTag">week</span>
              <span class="tag">boss</span>
              <span class="tag" id="bossRewardTag">+0 XP</span>
            </div>
            <div class="text" id="bossText">Boss challenge will load here.</div>
            <div class="row" style="margin-top:10px">
              <button class="btn small" id="loadBossBtn" type="button">Load</button>
              <button class="btn small" id="markBossBtn" type="button">Mark done</button>
            </div>
          </div>
        </div>

        <div class="muted" style="font-size:12px; margin-top:12px; line-height:1.4">
          Saved in your browser. No account.
        </div>

        <h2 style="margin-top:14px">Recent logs</h2>
        <div style="overflow:auto; margin-top:6px">
          <table>
            <thead>
              <tr>
                <th style="min-width:140px">Time</th>
                <th>Challenge</th>
                <th style="min-width:120px">Result</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="3" class="muted">No logs yet.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="stat" style="flex:1 1 auto">
            <div class="k">Total logs</div>
            <div class="v" id="total">0</div>
          </div>
          <div class="stat" style="flex:1 1 auto">
            <div class="k">No rate</div>
            <div class="v" id="rate">0%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const pack = $("pack");
  const category = $("category");
  const difficulty = $("difficulty");
  const timebox = $("timebox");

  const diffLabel = $("diffLabel");
  const tagPack = $("tagPack");
  const tagCat = $("tagCat");
  const tagDiff = $("tagDiff");
  const tagMode = $("tagMode");

  const challengeText = $("challengeText");
  const timerText = $("timerText");

  const where = $("where");
  const who = $("who");
  const before = $("before");
  const after = $("after");
  const beforeLabel = $("beforeLabel");
  const afterLabel = $("afterLabel");
  const note = $("note");

  const newBtn = $("newBtn");
  const todayBtn = $("todayBtn");
  const acceptedBtn = $("acceptedBtn");
  const rejectedBtn = $("rejectedBtn");
  const exportBtn = $("exportBtn");
  const resetBtn = $("resetBtn");
  const copyLinkBtn = $("copyLinkBtn");
  const shareAppBtn = $("shareAppBtn");
  const copyImageBtn = $("copyImageBtn");
  const downloadImageBtn = $("downloadImageBtn");
  const startTodayBtn = $("startTodayBtn");

  const shareCard = $("shareCard");
  const shareStamp = $("shareStamp");
  const sharePack = $("sharePack");
  const shareCat = $("shareCat");
  const shareDiff = $("shareDiff");
  const shareText = $("shareText");

  const planGrid = $("planGrid");
  const planProgressFill = $("planProgressFill");
  const planProgressText = $("planProgressText");
  const heroProgressFill = $("heroProgressFill");
  const heroProgressText = $("heroProgressText");
  const printPlanBtn = $("printPlanBtn");
  const markAllDoneBtn = $("markAllDoneBtn");
  const clearPlanBtn = $("clearPlanBtn");

  const streakEl = $("streak");
  const totalEl = $("total");
  const rateEl = $("rate");
  const logBody = $("logBody");
  const toast = $("toast");

  const STORAGE_KEY = "rr_logs_v4";
  const STREAK_KEY = "rr_rej_streak_v4";
  const LAST_REJ_DAY_KEY = "rr_last_rej_day_v4";
  const PLAN_DONE_KEY = "rr_plan_done_v3";

  let currentChallenge = null;
  let currentMode = "random";
  let timer = null;
  let timerEndsAt = null;

  function nowISO() { return new Date().toISOString(); }
  function dayKey(d = new Date()) { return d.toISOString().slice(0,10); }

  function toastMsg(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> toast.style.display="none", 1700);
  }

  function hash32(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function seededIndex(n, seedStr){
    const seed = hash32(seedStr);
    const x = (Math.imul(seed, 1664525) + 1013904223) >>> 0;
    return n ? (x % n) : 0;
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  function loadLogs(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
    catch { return []; }
  }
  function saveLogs(logs){ localStorage.setItem(STORAGE_KEY, JSON.stringify(logs)); }

  function loadStreak(){
    try { return JSON.parse(localStorage.getItem(STREAK_KEY) || "0"); }
    catch { return 0; }
  }
  function saveStreak(n){ localStorage.setItem(STREAK_KEY, JSON.stringify(n)); }

  function loadPlanDone(){
    try { return JSON.parse(localStorage.getItem(PLAN_DONE_KEY) || "{}"); }
    catch { return {}; }
  }
  function savePlanDone(obj){ localStorage.setItem(PLAN_DONE_KEY, JSON.stringify(obj)); }

  const packFilters = {
    all: (c) => true,
    beginner: (c) => c.diff <= 2,
    networking: (c) => c.cat === "career" || (c.cat === "social" && c.diff <= 4),
    wholesome: (c) => c.cat === "weird" || (c.cat === "social"),
    negotiation: (c) => c.cat === "negotiation"
  };

  const challenges = [
    {cat:"food", diff:1, text:"Ask a barista for a recommendation that’s not the usual."},
    {cat:"food", diff:2, text:"Ask for a tiny sample before you buy (and accept no)."},
    {cat:"food", diff:3, text:"Ask if they can make your drink half-sweet."},
    {cat:"food", diff:4, text:"Ask for a surprise under $5. Let them pick."},
    {cat:"food", diff:5, text:"Ask for a small swap (side/topping). If it’s a no, it’s a no."},

    {cat:"social", diff:1, text:"Give a genuine compliment and keep walking."},
    {cat:"social", diff:2, text:"Ask someone where they got something you like."},
    {cat:"social", diff:3, text:"Ask a stranger to rate your outfit 1–10. Thank them either way."},
    {cat:"social", diff:4, text:"Ask someone to take a quick photo of you (offer to return the favor)."},
    {cat:"social", diff:5, text:"Ask a group if you can join for 60 seconds of small talk, then bounce."},

    {cat:"help", diff:1, text:"Ask for directions to a place you already know."},
    {cat:"help", diff:2, text:"Ask for a nearby spot they actually like."},
    {cat:"help", diff:3, text:"Ask to borrow a pen for 30 seconds."},
    {cat:"help", diff:4, text:"Ask an employee to help you pick between two options."},
    {cat:"help", diff:5, text:"Ask someone to hear your 15-second intro and give one note."},

    {cat:"negotiation", diff:1, text:"Ask if there’s a student discount."},
    {cat:"negotiation", diff:2, text:"Ask if they can waive a tiny fee just this once."},
    {cat:"negotiation", diff:3, text:"Ask for a small upgrade (size/seat/etc.)."},
    {cat:"negotiation", diff:4, text:"Ask for $1–$2 off a small purchase. Smile either way."},
    {cat:"negotiation", diff:5, text:"Ask for a free add-on. If no, thank them and move on."},

    {cat:"weird", diff:1, text:"Ask a harmless silly question: ‘Do pigeons have a leader?’"},
    {cat:"weird", diff:2, text:"Ask a cashier: ‘Is today more of a 7 or a 9?’"},
    {cat:"weird", diff:3, text:"Ask for a 10-second pep talk. Time it."},
    {cat:"weird", diff:4, text:"Ask a stranger for their best time-saving life hack."},
    {cat:"weird", diff:5, text:"Ask if someone will say ‘you’ve got this’ on video (only if they’re into it)."},
    
    {cat:"career", diff:1, text:"Ask what they do for work and what they enjoy about it."},
    {cat:"career", diff:2, text:"Ask for one piece of advice for someone early-career."},
    {cat:"career", diff:3, text:"Ask if they’d be open to a 10-minute coffee chat sometime."},
    {cat:"career", diff:4, text:"Ask if there’s one person you should meet (and why)."},
    {cat:"career", diff:5, text:"Ask for feedback on your 15-second intro on the spot."}
  ];

  function encodeChallenge(ch){
    const payload = {cat:ch.cat, diff:ch.diff, text:ch.text, mode: currentMode, pack: pack.value};
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    return b64.replaceAll("=", "");
  }
  function decodeChallenge(str){
    try{
      const pad = str + "===".slice((str.length % 4) || 4);
      const json = decodeURIComponent(escape(atob(pad)));
      const obj = JSON.parse(json);
      if (!obj || !obj.text) return null;
      return obj;
    } catch { return null; }
  }

  function updateTags(){
    diffLabel.textContent = difficulty.value;
    beforeLabel.textContent = before.value;
    afterLabel.textContent = after.value;

    tagPack.textContent = "pack: " + pack.value;
    tagCat.textContent = category.value;
    tagDiff.textContent = "heat: " + difficulty.value;
    tagMode.textContent = "mode: " + currentMode;

    sharePack.textContent = "pack: " + pack.value;
    shareCat.textContent = category.value;
    shareDiff.textContent = "d" + difficulty.value;
    shareStamp.textContent = (currentMode === "today") ? "today" : "random";
  }

  function setChallenge(ch){
    currentChallenge = ch;
    challengeText.textContent = ch.text;
    shareText.textContent = ch.text;

    const share = new URL(location.href);
    share.searchParams.set("c", encodeChallenge(ch));
    history.replaceState(null, "", share.toString());
  }

  function filteredPool(){
    const p = pack.value;
    const cat = category.value;
    const diff = parseInt(difficulty.value, 10);

    return challenges.filter(c => {
      if (!packFilters[p](c)) return false;
      if (cat !== "any" && c.cat !== cat) return false;
      if (c.diff !== diff) return false;
      return true;
    });
  }

  function fallbackPool(){
    const p = pack.value;
    const cat = category.value;
    return challenges.filter(c => {
      if (!packFilters[p](c)) return false;
      if (cat !== "any" && c.cat !== cat) return false;
      return true;
    });
  }

  function pickRandomChallenge(){
    let pool = filteredPool();
    if (!pool.length) pool = fallbackPool();
    if (!pool.length) pool = challenges.slice();
    return pool[Math.floor(Math.random() * pool.length)];
  }

  function pickTodaysChallenge(){
    let pool = filteredPool();
    if (!pool.length) pool = fallbackPool();
    if (!pool.length) pool = challenges.slice();
    const seedStr = dayKey() + "|" + pack.value + "|" + category.value + "|" + difficulty.value;
    return pool[seededIndex(pool.length, seedStr)];
  }

  function startTimer(){
    stopTimer();
    const minutes = parseInt(timebox.value, 10);
    if (!minutes){ timerText.textContent = ""; return; }
    timerEndsAt = Date.now() + minutes * 60 * 1000;
    const tick = () => {
      const ms = timerEndsAt - Date.now();
      if (ms <= 0){
        timerText.textContent = "Timer done. Go do it.";
        stopTimer();
        return;
      }
      const m = Math.floor(ms / 60000);
      const s = Math.floor((ms % 60000) / 1000);
      timerText.textContent = "Time left: " + m + ":" + String(s).padStart(2,"0");
    };
    tick();
    timer = setInterval(tick, 250);
  }
  function stopTimer(){
    if (timer) clearInterval(timer);
    timer = null;
    timerEndsAt = null;
  }

  function updateRejectionStreakOnRejectedLog(){
    const today = dayKey();
    const last = localStorage.getItem(LAST_REJ_DAY_KEY);
    let streak = loadStreak();

    if (!last){
      streak = 1;
    } else {
      const lastDate = new Date(last + "T00:00:00");
      const todayDate = new Date(today + "T00:00:00");
      const diffDays = Math.round((todayDate - lastDate) / (24*60*60*1000));

      if (diffDays === 0){
        // already counted today
      } else if (diffDays === 1){
        streak += 1;
      } else {
        streak = 1;
      }
    }
    localStorage.setItem(LAST_REJ_DAY_KEY, today);
    saveStreak(streak);
  }

  function clearLogFields(){
    where.value = "";
    who.value = "";
    note.value = "";
    before.value = "3";
    after.value = "3";
    beforeLabel.textContent = "3";
    afterLabel.textContent = "3";
  }

  function updateStats(){
    const logs = loadLogs();
    totalEl.textContent = logs.length;

    const rejected = logs.filter(x => x.result === "rejected").length;
    const rate = logs.length ? Math.round((rejected / logs.length) * 100) : 0;
    rateEl.textContent = rate + "%";

    streakEl.textContent = loadStreak();
    renderLogs(logs);
    renderGameUI();
  }

  function renderLogs(logs){
    if (!logs.length){
      logBody.innerHTML = `<tr><td colspan="3" class="muted">No logs yet.</td></tr>`;
      return;
    }
    const rows = logs.slice().reverse().slice(0, 12).map(l => {
      const dt = new Date(l.time);
      const when = dt.toLocaleString([], {year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      const res = (l.result === "rejected") ? "No" : "Yes";

      const metaBits = [
        `<span class="tag">${escapeHtml(l.pack || "all")}</span>`,
        `<span class="tag">${escapeHtml(l.cat)}</span>`,
        `<span class="tag">d${escapeHtml(String(l.diff))}</span>`,
        l.where ? `<span class="tag">where: ${escapeHtml(l.where)}</span>` : "",
        l.who ? `<span class="tag">who: ${escapeHtml(l.who)}</span>` : "",
        (l.before && l.after) ? `<span class="tag">feel ${escapeHtml(String(l.before))}→${escapeHtml(String(l.after))}</span>` : ""
      ].filter(Boolean).join(" ");

      const extra = l.note ? `<div class="muted" style="margin-top:6px">${escapeHtml(l.note)}</div>` : "";

      return `
        <tr>
          <td>${escapeHtml(when)}</td>
          <td>
            <div style="font-weight:1000">${escapeHtml(l.challenge)}</div>
            <div class="muted" style="margin-top:6px; display:flex; gap:6px; flex-wrap:wrap">
              ${metaBits}
            </div>
            ${extra}
          </td>
          <td>${res}</td>
        </tr>
      `;
    }).join("");
    logBody.innerHTML = rows;
  }

  async function copyCurrentLink(){
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      toastMsg("Link copied.");
    } catch {
      prompt("Copy this link:", url);
    }
  }

  async function shareApp(){
    const url = location.origin + location.pathname;
    if (navigator.share){
      try{ await navigator.share({title:"Rejection Challenge", text:"Try this:", url}); }
      catch {}
    } else {
      try{
        await navigator.clipboard.writeText(url);
        toastMsg("App link copied.");
      } catch {
        prompt("Copy this app link:", url);
      }
    }
  }

  async function renderShareCardToCanvas(){
    await new Promise(r => setTimeout(r, 50));
    const canvas = await html2canvas(shareCard, {backgroundColor: null, scale: 2});
    return canvas;
  }

  async function copyShareCardAsImage(){
    if (!currentChallenge){
      toastMsg("Deal a prompt first.");
      return;
    }
    try{
      const canvas = await renderShareCardToCanvas();
      const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
      if (!blob) throw new Error("No image blob");

      if (navigator.clipboard && window.ClipboardItem){
        await navigator.clipboard.write([new ClipboardItem({"image/png": blob})]);
        toastMsg("Image copied.");
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "rejection-card.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toastMsg("Downloaded.");
      }
    } catch {
      toastMsg("Couldn’t copy. Try Download.");
    }
  }

  async function downloadShareCard(){
    if (!currentChallenge){
      toastMsg("Deal a prompt first.");
      return;
    }
    const canvas = await renderShareCardToCanvas();
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = "rejection-card.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
    toastMsg("Downloaded.");
  }

  function exportCSV(){
    const logs = loadLogs();
    if (!logs.length){ toastMsg("Nothing to export yet."); return; }

    const header = ["time_iso","result","mode","pack","category","difficulty","challenge","where","who","feeling_before","feeling_after","note"];
    const rows = logs.map(l => [
      l.time,
      l.result,
      l.mode || "",
      l.pack || "",
      l.cat,
      String(l.diff),
      (l.challenge || "").replaceAll('"','""'),
      (l.where || "").replaceAll('"','""'),
      (l.who || "").replaceAll('"','""'),
      String(l.before ?? ""),
      String(l.after ?? ""),
      (l.note || "").replaceAll('"','""')
    ]);

    const csv = [header.join(","), ...rows.map(r => r.map(v => `"${v}"`).join(","))].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rejection-logs.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ======================
  // Game system
  // ======================
  const GAME_KEY = "rr_game_v1";

  function defaultGame(){
    return {
      xp: 0,
      level: 1,
      shields: 1,
      lastShieldWeek: null,
      badges: {},
      questDay: null,
      quests: [],
      questDone: {},
      bossWeek: null,
      bossDone: false
    };
  }
  function loadGame(){
    try { return JSON.parse(localStorage.getItem(GAME_KEY) || "null") || defaultGame(); }
    catch { return defaultGame(); }
  }
  function saveGame(g){ localStorage.setItem(GAME_KEY, JSON.stringify(g)); }

  function isoWeekKey(date = new Date()){
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
    return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
  }

  function xpForLog(entry){
    const base = (entry.result === "rejected") ? 25 : 10;
    const diffBonus = (entry.diff || 3) * 6;
    const catBonus = (entry.cat === "negotiation" || entry.cat === "career") ? 6 : 0;
    return base + diffBonus + catBonus;
  }

  function levelForXP(xp){
    let lvl = 1;
    let need = 100;
    let spent = 0;
    while (xp >= spent + need){
      spent += need;
      lvl += 1;
      need = Math.floor(need * 1.2) + 20;
    }
    return {level: lvl, into: xp - spent, need};
  }

  function awardXP(amount, reason){
    const g = loadGame();
    g.xp += amount;
    const beforeLevel = g.level;
    const lv = levelForXP(g.xp);
    g.level = lv.level;
    saveGame(g);
    renderGameUI();
    if (g.level > beforeLevel){
      toastMsg(`Level up: ${beforeLevel} → ${g.level}`);
    } else if (reason){
      toastMsg(`${reason} +${amount} XP`);
    }
  }

  function unlockBadge(id, name){
    const g = loadGame();
    if (!g.badges[id]){
      g.badges[id] = {name, at: nowISO()};
      saveGame(g);
      renderGameUI();
      toastMsg(`Badge: ${name}`);
    }
  }

  function buildDailyQuests(){
    const today = dayKey();
    const g = loadGame();
    if (g.questDay === today && g.quests?.length) return;

    const seed = "quests|" + today;
    const cats = ["social","help","food","career","negotiation","weird"];
    const catPick = cats[seededIndex(cats.length, seed)];
    const quests = [
      {id:"q_rej", title:"Get 1 no today", desc:"Log at least one “Got a no” today.", reward: 60},
      {id:"q_newcat", title:`Try: ${catPick}`, desc:"Log any result in today’s category.", reward: 40, cat: catPick},
      {id:"q_hard", title:"Heat 4+", desc:"Log any result at heat 4 or 5.", reward: 50}
    ];

    g.questDay = today;
    g.quests = quests;
    g.questDone = g.questDone || {};
    saveGame(g);
  }

  function checkQuestCompletionOnLog(){
    const g = loadGame();
    if (g.questDay !== dayKey()) buildDailyQuests();

    const today = dayKey();
    const doneKey = (qid) => `${today}:${qid}`;
    const markDone = (qid) => { g.questDone[doneKey(qid)] = true; };

    const logs = loadLogs();
    const todayLogs = logs.filter(l => (l.time || "").slice(0,10) === today);

    if (!g.questDone[doneKey("q_rej")] && todayLogs.some(l => l.result === "rejected")){
      markDone("q_rej");
      awardXP(60, "Quest");
    }

    const qCat = g.quests?.find(q => q.id === "q_newcat")?.cat;
    if (qCat && !g.questDone[doneKey("q_newcat")] && todayLogs.some(l => l.cat === qCat)){
      markDone("q_newcat");
      awardXP(40, "Quest");
    }

    if (!g.questDone[doneKey("q_hard")] && todayLogs.some(l => (l.diff || 0) >= 4)){
      markDone("q_hard");
      awardXP(50, "Quest");
    }

    saveGame(g);
    renderGameUI();
  }

  function renderQuests(){
    const host = $("quests");
    if (!host) return;

    buildDailyQuests();
    const g = loadGame();
    const today = dayKey();
    const doneKey = (qid) => `${today}:${qid}`;

    host.innerHTML = (g.quests || []).map(q => {
      const done = !!g.questDone?.[doneKey(q.id)];
      return `
        <div class="q">
          <div>
            <div class="t">${escapeHtml(q.title)}</div>
            <div class="d">${escapeHtml(q.desc)} <span class="tag" style="margin-left:6px">+${q.reward} XP</span></div>
          </div>
          <div class="tag" style="min-width:70px; text-align:center">${done ? "done" : "open"}</div>
        </div>
      `;
    }).join("");
  }

  function renderBadges(){
    const host = $("badges");
    if (!host) return;

    const g = loadGame();
    const all = [
      {id:"b_first_no", name:"First No"},
      {id:"b_three_streak", name:"3-day streak"},
      {id:"b_week_boss", name:"Boss down"},
      {id:"b_neg_5", name:"Negotiator"},
      {id:"b_career_5", name:"Networker"},
      {id:"b_social_10", name:"Social beast"}
    ];

    host.innerHTML = all.map(b => {
      const have = !!g.badges?.[b.id];
      return `<span class="badge ${have ? "" : "locked"}">${escapeHtml(b.name)}</span>`;
    }).join("");
  }

  function renderLevel(){
    const g = loadGame();
    const levelEl = $("level");
    const xpEl = $("xp");
    const shieldsEl = $("shields");
    if (levelEl) levelEl.textContent = String(g.level);
    if (xpEl) xpEl.textContent = String(g.xp);
    if (shieldsEl) shieldsEl.textContent = String(g.shields || 0);
  }

  function renderStreakHint(){
    const el = $("streakHint");
    if (!el) return;
    const today = dayKey();
    const last = localStorage.getItem(LAST_REJ_DAY_KEY);

    if (!last) { el.textContent = "Log one “no” today to start."; return; }
    if (last === today) { el.textContent = "Counted for today. Extra no’s welcome."; return; }

    const lastDate = new Date(last + "T00:00:00");
    const todayDate = new Date(today + "T00:00:00");
    const diffDays = Math.round((todayDate - lastDate) / (24*60*60*1000));
    el.textContent = (diffDays === 1)
      ? "One “no” today keeps it going."
      : "Log a “no” today to restart the streak.";
  }

  function bossChallengeForWeek(){
    const wk = isoWeekKey(new Date());
    const seedStr = "boss|" + wk;
    const pool = challenges.filter(c => (c.diff >= 4) && (c.cat === "career" || c.cat === "negotiation" || c.cat === "social"));
    const chosen = pool[seededIndex(pool.length, seedStr)];
    const reward = 160 + chosen.diff * 20;
    return {week: wk, text: chosen.text, cat: chosen.cat, diff: chosen.diff, reward};
  }

  function renderBoss(){
    const bossText = $("bossText");
    const bossWeekTag = $("bossWeekTag");
    const bossRewardTag = $("bossRewardTag");
    if (!bossText || !bossWeekTag || !bossRewardTag) return;

    const b = bossChallengeForWeek();
    const g = loadGame();
    if (g.bossWeek !== b.week){
      g.bossWeek = b.week;
      g.bossDone = false;
      saveGame(g);
    }

    bossWeekTag.textContent = b.week;
    bossRewardTag.textContent = `+${b.reward} XP`;
    bossText.textContent = g.bossDone ? (b.text + " (done)") : b.text;

    const loadBtn = $("loadBossBtn");
    const markBtn = $("markBossBtn");

    if (loadBtn && !loadBtn._wired){
      loadBtn._wired = true;
      loadBtn.addEventListener("click", () => {
        category.value = b.cat;
        difficulty.value = String(b.diff);
        currentMode = "today";
        updateTags();
        setChallenge({cat:b.cat, diff:b.diff, text: b.text + " (boss)"});
        startTimer();
        updateTags();
        location.hash = "#tracker";
        toastMsg("Boss loaded.");
      });
    }

    if (markBtn && !markBtn._wired){
      markBtn._wired = true;
      markBtn.addEventListener("click", () => {
        const gg = loadGame();
        const bb = bossChallengeForWeek();
        if (gg.bossDone){ toastMsg("Already done this week."); return; }
        gg.bossDone = true;
        saveGame(gg);
        awardXP(bb.reward, "Boss");
        unlockBadge("b_week_boss", "Boss down");
        renderGameUI();
      });
    }
  }

  function maybeGrantWeeklyShield(){
    const g = loadGame();
    const wk = isoWeekKey(new Date());
    if (g.lastShieldWeek !== wk){
      g.lastShieldWeek = wk;
      g.shields = (g.shields || 0) + 1;
      saveGame(g);
      toastMsg("Weekly shield earned.");
    }
  }

  function renderGameUI(){
    maybeGrantWeeklyShield();
    renderLevel();
    renderQuests();
    renderBadges();
    renderBoss();
    renderStreakHint();
  }

  function logResult(result){
    if (!currentChallenge){
      toastMsg("Deal a prompt first.");
      return;
    }
    const logs = loadLogs();
    const entry = {
      time: nowISO(),
      result,
      mode: currentMode,
      pack: pack.value,
      cat: currentChallenge.cat,
      diff: currentChallenge.diff,
      challenge: currentChallenge.text,
      where: where.value.trim(),
      who: who.value.trim(),
      before: parseInt(before.value,10),
      after: parseInt(after.value,10),
      note: note.value.trim()
    };
    logs.push(entry);
    saveLogs(logs);

    if (result === "rejected"){
      updateRejectionStreakOnRejectedLog();
      toastMsg("Logged. Nice.");
    } else {
      toastMsg("Logged.");
    }

    awardXP(xpForLog(entry), "Logged");
    checkQuestCompletionOnLog();

    const allLogs = loadLogs();
    if (allLogs.some(l => l.result === "rejected")) unlockBadge("b_first_no", "First No");

    const negCount = allLogs.filter(l => l.cat === "negotiation").length;
    if (negCount >= 5) unlockBadge("b_neg_5", "Negotiator");

    const careerCount = allLogs.filter(l => l.cat === "career").length;
    if (careerCount >= 5) unlockBadge("b_career_5", "Networker");

    const socialCount = allLogs.filter(l => l.cat === "social").length;
    if (socialCount >= 10) unlockBadge("b_social_10", "Social beast");

    if (loadStreak() >= 3) unlockBadge("b_three_streak", "3-day streak");

    clearLogFields();
    updateStats();
  }

  function daySpec(day){
    if (day <= 5) return {diff: 1 + (day >= 3 ? 1 : 0), cat: (day % 2 ? "social" : "help"), label:"low"};
    if (day <= 15) return {diff: 2 + (day >= 10 ? 1 : 0), cat: (day % 3 === 0 ? "career" : "social"), label:"mid"};
    const stretchCat = (day % 4 === 0) ? "career" : (day % 3 === 0 ? "negotiation" : "social");
    const stretchDiff = (day <= 20) ? 3 : (day <= 25 ? 4 : 5);
    return {diff: stretchDiff, cat: stretchCat, label:"spicy"};
  }

  function planDoneCount(){
    const done = loadPlanDone();
    return Object.values(done).filter(Boolean).length;
  }

  function updateHeroProgress(){
    const completed = planDoneCount();
    const pct = Math.round((completed / 30) * 100);
    heroProgressFill.style.width = pct + "%";
    heroProgressText.textContent = completed + "/30";
  }

  function renderPlan(){
    const done = loadPlanDone();
    let completed = 0;

    const cards = [];
    for (let day = 1; day <= 30; day++){
      const checked = !!done[String(day)];
      if (checked) completed++;

      const spec = daySpec(day);
      const seedStr = "plan|" + String(day);
      const pool = challenges.filter(c => c.cat === spec.cat && c.diff === spec.diff);
      const chosen = pool.length ? pool[seededIndex(pool.length, seedStr)] : challenges[seededIndex(challenges.length, seedStr)];

      cards.push(`
        <div class="dayCard">
          <div class="dayTop">
            <div>
              <div class="dayTitle">Day ${day} <span class="tag" style="margin-left:6px">${spec.label}</span></div>
              <div class="dayMeta">
                <span class="tag">${spec.cat}</span>
                <span class="tag">d${spec.diff}</span>
              </div>
            </div>
            <label class="tag" style="cursor:pointer; user-select:none">
              <input type="checkbox" data-day="${day}" ${checked ? "checked" : ""} style="margin-right:6px; transform:translateY(1px)" />
              done
            </label>
          </div>

          <div class="dayText">${escapeHtml(chosen.text)}</div>

          <div class="dayActions">
            <button class="btn small" data-start-day="${day}" data-cat="${spec.cat}" data-diff="${spec.diff}">Start</button>
            <button class="btn small" data-copy-day="${day}" data-text="${escapeHtml(chosen.text)}">Copy</button>
          </div>
        </div>
      `);
    }

    planGrid.innerHTML = cards.join("");

    const pct = Math.round((completed / 30) * 100);
    planProgressFill.style.width = pct + "%";
    planProgressText.textContent = completed + "/30";

    planGrid.querySelectorAll('input[type="checkbox"][data-day]').forEach(cb => {
      cb.addEventListener("change", (e) => {
        const d = parseInt(e.target.getAttribute("data-day"), 10);
        const obj = loadPlanDone();
        obj[String(d)] = !!e.target.checked;
        savePlanDone(obj);
        renderPlan();
        updateHeroProgress();
      });
    });

    planGrid.querySelectorAll('button[data-start-day]').forEach(btn => {
      btn.addEventListener("click", () => {
        const cat = btn.getAttribute("data-cat");
        const diff = btn.getAttribute("data-diff");

        category.value = cat;
        difficulty.value = diff;

        location.hash = "#tracker";
        currentMode = "today";
        updateTags();
        setChallenge(pickTodaysChallenge());
        startTimer();
        updateTags();
        toastMsg("Loaded.");
      });
    });

    planGrid.querySelectorAll('button[data-copy-day]').forEach(btn => {
      btn.addEventListener("click", async () => {
        const text = btn.getAttribute("data-text") || "";
        try{
          await navigator.clipboard.writeText(text);
          toastMsg("Copied.");
        } catch {
          prompt("Copy this:", text);
        }
      });
    });
  }

  function generate(mode){
    currentMode = mode;
    updateTags();
    const ch = (mode === "today") ? pickTodaysChallenge() : pickRandomChallenge();
    setChallenge(ch);
    startTimer();
    updateTags();
  }

  function resetAll(){
    if (!confirm("Reset everything on this device?")) return;
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(STREAK_KEY);
    localStorage.removeItem(LAST_REJ_DAY_KEY);
    localStorage.removeItem(PLAN_DONE_KEY);
    localStorage.removeItem(GAME_KEY);
    toastMsg("Reset.");
    renderPlan();
    updateHeroProgress();
    updateStats();
    renderGameUI();
  }

  function syncMeta(){ updateTags(); }
  difficulty.addEventListener("input", syncMeta);
  before.addEventListener("input", syncMeta);
  after.addEventListener("input", syncMeta);
  category.addEventListener("change", syncMeta);
  pack.addEventListener("change", syncMeta);
  timebox.addEventListener("change", () => startTimer());

  newBtn.addEventListener("click", () => generate("random"));
  todayBtn.addEventListener("click", () => generate("today"));
  acceptedBtn.addEventListener("click", () => logResult("accepted"));
  rejectedBtn.addEventListener("click", () => logResult("rejected"));
  exportBtn.addEventListener("click", exportCSV);
  resetBtn.addEventListener("click", resetAll);
  copyLinkBtn.addEventListener("click", copyCurrentLink);
  shareAppBtn.addEventListener("click", shareApp);
  copyImageBtn.addEventListener("click", copyShareCardAsImage);
  downloadImageBtn.addEventListener("click", downloadShareCard);

  startTodayBtn.addEventListener("click", () => {
    location.hash = "#tracker";
    generate("today");
  });

  document.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === "g") generate("random");
    if (k === "t") generate("today");
    if (k === "r") logResult("rejected");
  });

  markAllDoneBtn.addEventListener("click", () => {
    const obj = {};
    for (let d=1; d<=30; d++) obj[String(d)] = true;
    savePlanDone(obj);
    renderPlan();
    updateHeroProgress();
    toastMsg("Marked.");
  });

  clearPlanBtn.addEventListener("click", () => {
    localStorage.removeItem(PLAN_DONE_KEY);
    renderPlan();
    updateHeroProgress();
    toastMsg("Cleared.");
  });

  printPlanBtn.addEventListener("click", () => {
    location.hash = "#plan";
    setTimeout(() => window.print(), 150);
  });

  const params = new URLSearchParams(location.search);
  const c = params.get("c");
  if (c){
    const decoded = decodeChallenge(c);
    if (decoded){
      currentChallenge = decoded;
      challengeText.textContent = decoded.text;
      shareText.textContent = decoded.text;

      if (decoded.pack && packFilters[decoded.pack]) pack.value = decoded.pack;
      category.value = ["food","social","help","negotiation","weird","career"].includes(decoded.cat) ? decoded.cat : "any";
      difficulty.value = String(Math.min(5, Math.max(1, parseInt(decoded.diff || 3,10) || 3)));

      currentMode = (decoded.mode === "today") ? "today" : "random";
    }
  }

  function renderGameUI(){
    // weekly shield + UI render
    maybeGrantWeeklyShield();
    renderLevel();
    renderQuests();
    renderBadges();
    renderBoss();
    renderStreakHint();
  }

  function renderStreakHint(){ /* redefined above, kept */ }

  updateTags();
  renderPlan();
  updateHeroProgress();
  updateStats();
  renderGameUI();
})();
</script>
</body>
</html>

