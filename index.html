<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rejection Challenge</title>
  <meta name="description" content="Spin a prompt, do it in person, log it. Warm, fun rejection practice. No login. Local-only logs." />

  <!-- Nice font (safe for GitHub Pages) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Warm, pleasant palette */
      --bg0:#140c09;
      --bg1:#1a100c;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --text:#fff4ee;
      --muted:rgba(255,244,238,.72);
      --muted2:rgba(255,244,238,.58);

      --accent:#ff7a59;    /* coral */
      --accent2:#ffb86b;   /* amber */
      --good:#4fd8a2;      /* mint */
      --bad:#ff5a7a;       /* pink-red */
      --line:rgba(255,244,238,.12);

      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --radius:22px;

      --sans:"Manrope", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono:"Space Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 520px at 12% 0%, rgba(255,122,89,.35), transparent 60%),
        radial-gradient(900px 520px at 100% 10%, rgba(255,184,107,.22), transparent 55%),
        radial-gradient(700px 420px at 40% 120%, rgba(79,216,162,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    a{color:inherit}
    .wrap{max-width:1100px; margin:0 auto; padding:26px 16px 64px}

    /* Top bar */
    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:16px;
      margin-bottom:14px;
    }
    .brand{display:flex; flex-direction:column; gap:6px}
    .titleRow{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .title{
      font-weight:800;
      letter-spacing:.2px;
      font-size:18px;
    }
    .pills{display:flex; gap:8px; flex-wrap:wrap}
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:rgba(255,244,238,.9);
      white-space:nowrap;
    }

    .btnRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-weight:800;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition:transform .06s ease, filter .14s ease, background .14s ease, border-color .14s ease;
      user-select:none;
      text-align:center;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.small{padding:8px 10px; font-size:13px}
    .btn.primary{
      background:linear-gradient(90deg, rgba(255,122,89,.98), rgba(255,184,107,.88));
      border-color:rgba(255,184,107,.35);
    }
    .btn.good{
      background:linear-gradient(90deg, rgba(79,216,162,.92), rgba(79,216,162,.62));
      border-color:rgba(79,216,162,.40);
    }
    .btn.bad{
      background:linear-gradient(90deg, rgba(255,90,122,.95), rgba(255,90,122,.62));
      border-color:rgba(255,90,122,.42);
    }
    .btn.ghost{background:transparent}

    /* Layout */
    .grid{display:grid; grid-template-columns:1.25fr .75fr; gap:14px; margin-top:14px}
    @media (max-width: 980px){
      header{flex-direction:column}
      .grid{grid-template-columns:1fr}
      .btnRow{justify-content:flex-start}
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.075), rgba(255,255,255,.04));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.2px;
      font-weight:800;
      color:rgba(255,244,238,.92);
    }
    .muted{color:var(--muted)}
    .muted2{color:var(--muted2)}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .row > *{flex:1 1 auto}

    label{
      display:block;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    select, input[type="range"], input[type="text"], textarea{
      width:100%;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:92px; resize:vertical}

    /* Hero */
    .hero{
      padding:18px 16px;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background:
        radial-gradient(1100px 420px at 0% 0%, rgba(255,122,89,.22), transparent 60%),
        radial-gradient(1100px 420px at 100% 0%, rgba(255,184,107,.16), transparent 60%),
        rgba(255,255,255,.05);
      box-shadow: var(--shadow);
    }
    .hero h1{
      margin:0;
      font-size:34px;
      line-height:1.1;
      letter-spacing:.2px;
      font-weight:900;
    }
    .hero p{
      margin:10px 0 0;
      color:var(--muted);
      max-width:78ch;
      line-height:1.5;
    }
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}

    /* Compass */
    .compassWrap{
      display:flex;
      gap:14px;
      align-items:center;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .compass{
      width:130px; height:130px;
      border-radius:999px;
      border:1px solid var(--line);
      background:
        radial-gradient(closest-side, rgba(255,255,255,.08), rgba(255,255,255,.03)),
        conic-gradient(from 220deg,
          rgba(79,216,162,.85),
          rgba(255,184,107,.85),
          rgba(255,122,89,.9),
          rgba(255,90,122,.9),
          rgba(79,216,162,.85)
        );
      position:relative;
      box-shadow: 0 18px 50px rgba(0,0,0,.35);
    }
    .compassInner{
      position:absolute; inset:10px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(25,15,12,.90), rgba(15,10,8,.88));
      border:1px solid rgba(255,244,238,.10);
      display:flex; flex-direction:column;
      align-items:center; justify-content:center;
      text-align:center;
    }
    .compassLabel{
      font-family:var(--mono);
      font-size:11px;
      color:rgba(255,244,238,.70);
    }
    .compassValue{
      font-size:30px;
      font-weight:900;
      margin-top:3px;
    }
    .needle{
      position:absolute;
      left:50%;
      top:50%;
      width:4px;
      height:44px;
      transform-origin:50% 90%;
      transform: translate(-50%,-90%) rotate(0deg);
      background:rgba(255,244,238,.92);
      border-radius:999px;
      box-shadow:0 8px 22px rgba(0,0,0,.45);
    }
    .needleDot{
      position:absolute;
      left:50%;
      top:50%;
      width:14px;
      height:14px;
      transform:translate(-50%,-50%);
      background:rgba(255,244,238,.95);
      border-radius:999px;
      border:1px solid rgba(0,0,0,.25);
    }
    .compassText{min-width:260px}
    .compassText b{color:rgba(255,244,238,.95)}
    .hintLine{
      margin-top:6px;
      font-size:12px;
      color:var(--muted2);
      line-height:1.4;
    }

    /* Prompt card */
    .prompt{
      border:1px solid rgba(255,244,238,.16);
      border-radius:18px;
      padding:14px;
      background:
        radial-gradient(800px 260px at 0% 0%, rgba(255,122,89,.18), transparent 60%),
        radial-gradient(800px 260px at 100% 0%, rgba(255,184,107,.14), transparent 60%),
        rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .promptTop{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      padding:4px 10px;
      border-radius:999px;
      font-family:var(--mono);
      font-size:12px;
      color:rgba(255,244,238,.88);
    }
    .promptText{
      margin:10px 0 6px;
      font-size:20px;
      font-weight:900;
      line-height:1.25;
      letter-spacing:.1px;
    }
    .promptSub{font-size:12px; color:var(--muted2)}
    .pulse{
      animation:pulse .38s ease;
    }
    @keyframes pulse{
      0%{transform:scale(.995)}
      50%{transform:scale(1.01)}
      100%{transform:scale(1)}
    }

    /* Stats */
    .statgrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width: 520px){ .statgrid{grid-template-columns:1fr} }
    .stat{
      padding:12px;
      border-radius:16px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
    }
    .stat .k{font-size:11px; color:var(--muted)}
    .stat .v{font-size:20px; font-weight:900; margin-top:4px}
    .bar{
      margin-top:8px;
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--line);
      overflow:hidden;
    }
    .bar > div{height:100%; width:0%; background:linear-gradient(90deg, rgba(255,184,107,.90), rgba(255,122,89,.95));}

    /* Logs table */
    table{width:100%; border-collapse:collapse; margin-top:8px; font-size:13px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,244,238,.10); vertical-align:top}
    th{color:var(--muted); font-weight:900; text-align:left; font-size:12px}
    .miniMeta{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}

    /* Custom prompt */
    .split{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width: 760px){ .split{grid-template-columns:1fr} }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(20,12,9,.92);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:999px;
      box-shadow:var(--shadow);
      display:none;
      font-size:13px;
      z-index:9999;
      max-width:min(92vw, 780px);
      text-align:center;
      backdrop-filter: blur(8px);
    }

    /* Confetti canvas */
    #confetti{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9998;
      display:none;
    }

    /* Small footer note */
    .footNote{
      margin-top:12px;
      color:var(--muted2);
      font-size:12px;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <header>
      <div class="brand">
        <div class="titleRow">
          <div class="title">Rejection Challenge</div>
          <div class="pills">
            <span class="pill">public</span>
            <span class="pill">no login</span>
            <span class="pill">local-only logs</span>
          </div>
        </div>
        <div class="muted" style="font-size:13px; line-height:1.4; max-width:78ch">
          Spin a prompt, do it in person, log it. A “no” counts as a win here.
        </div>
      </div>

      <div class="btnRow">
        <button class="btn small" id="shareBtn" title="Copy the app link">Share</button>
        <button class="btn small" id="exportBtn" title="Download your logs as CSV">Export</button>
        <button class="btn small" id="resetBtn" title="Clears your local data">Reset</button>
      </div>
    </header>

    <section class="hero">
      <h1>Get comfortable hearing “no”.</h1>
      <p>
        One small ask a day. Keep it respectful. Log what happened. Your streak only cares about rejections.
      </p>
      <div class="heroActions">
        <a class="btn primary" href="#tracker">Open tracker</a>
        <button class="btn" id="spinTopBtn">Spin a prompt</button>
        <button class="btn ghost" id="todaysTopBtn">Today’s prompt</button>
      </div>
    </section>

    <div class="grid" id="tracker" style="scroll-margin-top:16px">
      <!-- Left: generator + logger -->
      <div class="card">
        <h2>Tracker</h2>

        <!-- Filters -->
        <div class="split">
          <div>
            <label for="category">Category</label>
            <select id="category">
              <option value="any" selected>Any</option>
              <option value="food">Food</option>
              <option value="social">Social</option>
              <option value="help">Help</option>
              <option value="negotiation">Negotiation</option>
              <option value="weird">Weird</option>
              <option value="career">Career</option>
              <option value="custom">Custom (yours)</option>
            </select>
          </div>

          <div>
            <label for="difficulty">Comfort Compass</label>
            <input id="difficulty" type="range" min="1" max="5" value="3" />
          </div>
        </div>

        <!-- Compass -->
        <div class="compassWrap">
          <div class="compass" aria-label="comfort compass">
            <div class="needle" id="needle"></div>
            <div class="needleDot"></div>
            <div class="compassInner">
              <div class="compassLabel">difficulty</div>
              <div class="compassValue" id="diffValue">3</div>
            </div>
          </div>
          <div class="compassText">
            <div><b id="diffName">Balanced</b></div>
            <div class="hintLine" id="diffHint">A little uncomfortable, still doable.</div>
            <div class="hintLine muted2">Tip: don’t overthink the filters. Just spin.</div>
          </div>
        </div>

        <!-- Prompt -->
        <div class="prompt" style="margin-top:12px">
          <div class="promptTop">
            <div class="tags">
              <span class="tag" id="tagCat">any</span>
              <span class="tag" id="tagDiff">d3</span>
              <span class="tag" id="tagMode">random</span>
            </div>
            <div class="row" style="flex:0 0 auto">
              <button class="btn small" id="copyPromptLinkBtn">Copy link</button>
              <button class="btn small" id="todaysBtn">Today</button>
              <button class="btn primary" id="spinBtn">Spin</button>
            </div>
          </div>

          <!-- THIS is the prompt text; it will always show -->
          <div class="promptText" id="promptText">Spin to get your first prompt.</div>
          <div class="promptSub" id="promptSub">Log it below when you’re done.</div>
        </div>

        <!-- Log inputs -->
        <div style="margin-top:12px">
          <div class="split">
            <div>
              <label for="where">Where (optional)</label>
              <input id="where" type="text" placeholder="coffee shop, campus, gym…" />
            </div>
            <div>
              <label for="who">Who (optional)</label>
              <input id="who" type="text" placeholder="barista, stranger, classmate…" />
            </div>
          </div>

          <div style="margin-top:10px">
            <label for="note">Note (optional)</label>
            <textarea id="note" placeholder="One line: what happened?"></textarea>
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn good" id="acceptedBtn">Accepted</button>
            <button class="btn bad" id="rejectedBtn">Rejected</button>
          </div>

          <div class="footNote">
            Keyboard: <span class="pill" style="padding:2px 8px">G</span> spin
            <span class="pill" style="padding:2px 8px">T</span> today
            <span class="pill" style="padding:2px 8px">R</span> log rejected
          </div>
        </div>

        <!-- Custom prompts -->
        <div class="card" style="margin-top:14px; box-shadow:none">
          <h2>Add your own prompts</h2>
          <div class="muted2" style="font-size:12px; margin-top:-6px">
            Stored locally. Pick “Custom (yours)” to spin from these.
          </div>
          <div class="split" style="margin-top:10px">
            <input id="customInput" type="text" placeholder="Write a prompt you’d actually do…" />
            <button class="btn" id="addCustomBtn">Add</button>
          </div>
          <div class="row" style="margin-top:10px">
            <button class="btn small" id="viewCustomBtn">View</button>
            <button class="btn small" id="clearCustomBtn">Clear</button>
          </div>
          <div class="muted2" id="customCount" style="font-size:12px; margin-top:8px"></div>
        </div>
      </div>

      <!-- Right: stats + logs -->
      <div class="card">
        <h2>Progress</h2>

        <div class="statgrid">
          <div class="stat">
            <div class="k">Rejection streak</div>
            <div class="v" id="streak">0</div>
            <div class="muted2" style="font-size:11px; margin-top:6px" id="streakHint">Log 1 rejection today to start.</div>
          </div>
          <div class="stat">
            <div class="k">Level</div>
            <div class="v" id="level">1</div>
            <div class="muted2" style="font-size:11px; margin-top:6px"><span id="xp">0</span> XP</div>
            <div class="bar"><div id="xpBar"></div></div>
          </div>
          <div class="stat">
            <div class="k">Badges</div>
            <div class="v" id="badgeCount">0</div>
            <div class="muted2" style="font-size:11px; margin-top:6px" id="badgeHint">Unlock by logging.</div>
          </div>
        </div>

        <div class="card" style="margin-top:12px; box-shadow:none">
          <h2>Daily quests</h2>
          <div class="muted2" style="font-size:12px; margin-top:-6px">Small bonuses. Keeps it playful.</div>
          <div id="quests" style="margin-top:10px; display:grid; gap:10px"></div>
        </div>

        <div class="card" style="margin-top:12px; box-shadow:none">
          <h2>Badges</h2>
          <div id="badges" style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap"></div>
        </div>

        <div class="footNote">
          This app is static: everyone sees the same page, but your logs stay in your browser only.
        </div>

        <h2 style="margin-top:14px">Recent logs</h2>
        <div style="overflow:auto; margin-top:6px">
          <table>
            <thead>
              <tr>
                <th style="min-width:140px">Time</th>
                <th>Prompt</th>
                <th style="min-width:120px">Result</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="3" class="muted">No logs yet.</td></tr>
            </tbody>
          </table>
        </div>

        <div class="row" style="margin-top:10px">
          <div class="stat" style="flex:1 1 auto; box-shadow:none">
            <div class="k">Total logs</div>
            <div class="v" id="total">0</div>
          </div>
          <div class="stat" style="flex:1 1 auto; box-shadow:none">
            <div class="k">Rejection rate</div>
            <div class="v" id="rate">0%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // Elements
  const category = $("category");
  const difficulty = $("difficulty");
  const diffValue = $("diffValue");
  const needle = $("needle");
  const diffName = $("diffName");
  const diffHint = $("diffHint");

  const tagCat = $("tagCat");
  const tagDiff = $("tagDiff");
  const tagMode = $("tagMode");

  const promptText = $("promptText");
  const promptSub = $("promptSub");

  const spinBtn = $("spinBtn");
  const todaysBtn = $("todaysBtn");
  const spinTopBtn = $("spinTopBtn");
  const todaysTopBtn = $("todaysTopBtn");

  const acceptedBtn = $("acceptedBtn");
  const rejectedBtn = $("rejectedBtn");

  const where = $("where");
  const who = $("who");
  const note = $("note");

  const copyPromptLinkBtn = $("copyPromptLinkBtn");
  const shareBtn = $("shareBtn");
  const exportBtn = $("exportBtn");
  const resetBtn = $("resetBtn");

  const logBody = $("logBody");
  const totalEl = $("total");
  const rateEl = $("rate");
  const streakEl = $("streak");
  const streakHint = $("streakHint");

  const levelEl = $("level");
  const xpEl = $("xp");
  const xpBar = $("xpBar");
  const badgeCountEl = $("badgeCount");

  const questsEl = $("quests");
  const badgesEl = $("badges");

  const customInput = $("customInput");
  const addCustomBtn = $("addCustomBtn");
  const viewCustomBtn = $("viewCustomBtn");
  const clearCustomBtn = $("clearCustomBtn");
  const customCount = $("customCount");

  const toast = $("toast");

  // Storage keys
  const K_LOGS = "rc_logs_v1";
  const K_STREAK = "rc_streak_v1";
  const K_LAST_REJ_DAY = "rc_last_rej_day_v1";
  const K_GAME = "rc_game_v1";
  const K_CUSTOM = "rc_custom_prompts_v1";
  const K_HISTORY = "rc_spin_history_v1";

  let current = null;
  let mode = "random"; // random | today

  // Helpers
  function dayKey(d = new Date()){
    return d.toISOString().slice(0,10);
  }
  function nowISO(){ return new Date().toISOString(); }
  function toastMsg(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> toast.style.display="none", 1800);
  }
  function hash32(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function seededIndex(n, seedStr){
    const seed = hash32(seedStr);
    const x = (Math.imul(seed, 1664525) + 1013904223) >>> 0;
    return n ? (x % n) : 0;
  }
  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }

  // Data: built-in prompts
  const prompts = [
    // Food
    {cat:"food", diff:1, text:"Ask a barista to recommend something not on the menu."},
    {cat:"food", diff:2, text:"Ask if they can make your drink less sweet."},
    {cat:"food", diff:3, text:"Ask for a surprise under $5 and let them choose."},
    {cat:"food", diff:4, text:"Ask for a small custom swap (side, topping). Accept no."},
    {cat:"food", diff:5, text:"Ask for a sample before buying. If no, thank them and move on."},

    // Social
    {cat:"social", diff:1, text:"Give a sincere compliment to a stranger and keep walking."},
    {cat:"social", diff:2, text:"Ask someone where they got an item because you like it."},
    {cat:"social", diff:3, text:"Ask a stranger to rate your outfit 1–10. Thank them either way."},
    {cat:"social", diff:4, text:"Ask someone to take a quick photo of you."},
    {cat:"social", diff:5, text:"Ask a group if you can join for 2 minutes to practice small talk."},

    // Help
    {cat:"help", diff:1, text:"Ask for directions to a nearby place you already know."},
    {cat:"help", diff:2, text:"Ask someone for a local spot they genuinely like."},
    {cat:"help", diff:3, text:"Ask to borrow a pen for 30 seconds."},
    {cat:"help", diff:4, text:"Ask an employee to help you pick between two options and say why."},
    {cat:"help", diff:5, text:"Ask someone to hear your 15-second intro and give one note."},

    // Negotiation
    {cat:"negotiation", diff:1, text:"Ask if there’s a student discount."},
    {cat:"negotiation", diff:2, text:"Ask if they can waive a small add-on fee once. Accept no."},
    {cat:"negotiation", diff:3, text:"Ask for a small upgrade (size, add-on, seat)."},
    {cat:"negotiation", diff:4, text:"Ask for $1–$2 off a small purchase. Accept no instantly."},
    {cat:"negotiation", diff:5, text:"Ask for a free extra (topping/add-on). If no, say thanks and go."},

    // Weird
    {cat:"weird", diff:1, text:"Ask someone a harmless silly question and leave. Example: do pigeons have a leader?"},
    {cat:"weird", diff:2, text:"Ask a cashier: is today more of a 7 or a 9?"},
    {cat:"weird", diff:3, text:"Ask someone for a 10-second pep talk. Time it."},
    {cat:"weird", diff:4, text:"Ask for a life hack that saves time."},
    {cat:"weird", diff:5, text:"Ask if someone will say ‘you’ve got this’ on video for 5 seconds (consent required)."},

    // Career
    {cat:"career", diff:1, text:"Ask someone what they do for work and what they enjoy about it."},
    {cat:"career", diff:2, text:"Ask for one piece of advice for someone early in their career."},
    {cat:"career", diff:3, text:"Ask if they’d be open to a 10-minute coffee chat this week. Totally okay if not."},
    {cat:"career", diff:4, text:"Ask if they know one person you should meet and why."},
    {cat:"career", diff:5, text:"Ask a professional for feedback on your 15-second intro on the spot."}
  ];

  // Custom prompts
  function loadCustom(){
    try{ return JSON.parse(localStorage.getItem(K_CUSTOM) || "[]"); } catch { return []; }
  }
  function saveCustom(arr){ localStorage.setItem(K_CUSTOM, JSON.stringify(arr)); }
  function updateCustomCount(){
    const n = loadCustom().length;
    customCount.textContent = n ? `${n} custom prompt(s) saved.` : "No custom prompts yet.";
  }

  // Logs
  function loadLogs(){ try{ return JSON.parse(localStorage.getItem(K_LOGS)||"[]"); } catch { return []; } }
  function saveLogs(arr){ localStorage.setItem(K_LOGS, JSON.stringify(arr)); }

  // Streak
  function loadStreak(){ try{ return JSON.parse(localStorage.getItem(K_STREAK)||"0"); } catch { return 0; } }
  function saveStreak(n){ localStorage.setItem(K_STREAK, JSON.stringify(n)); }

  // History to prevent repeats
  function loadHistory(){ try{ return JSON.parse(localStorage.getItem(K_HISTORY)||"[]"); } catch { return []; } }
  function saveHistory(h){ localStorage.setItem(K_HISTORY, JSON.stringify(h)); }
  function promptId(p){ return `${p.cat}|${p.diff}|${p.text}`; }

  // Game
  function defaultGame(){
    return {
      xp:0,
      badges:{},
      questDay:null,
      questDone:{},
      quests:[]
    };
  }
  function loadGame(){ try{ return JSON.parse(localStorage.getItem(K_GAME)||"null") || defaultGame(); } catch { return defaultGame(); } }
  function saveGame(g){ localStorage.setItem(K_GAME, JSON.stringify(g)); }

  function levelFromXP(xp){
    let lvl = 1, need = 120, spent = 0;
    while (xp >= spent + need){
      spent += need;
      lvl++;
      need = Math.floor(need * 1.18) + 24;
    }
    return {level:lvl, into: xp - spent, need};
  }

  // Compass UI mapping
  const diffMap = {
    1:{name:"Warm-up", hint:"Tiny ask. Mostly about showing up."},
    2:{name:"Easy", hint:"Slightly uncomfortable, low risk."},
    3:{name:"Balanced", hint:"A little uncomfortable, still doable."},
    4:{name:"Stretch", hint:"You’ll feel it. Good rep."},
    5:{name:"Spicy", hint:"Big ask. Respectful + quick."}
  };

  function setCompass(v){
    const d = Number(v);
    diffValue.textContent = String(d);
    diffName.textContent = diffMap[d].name;
    diffHint.textContent = diffMap[d].hint;

    // needle rotation: map 1..5 into -110..110
    const deg = -110 + (d-1) * (220/4);
    needle.style.transform = `translate(-50%,-90%) rotate(${deg}deg)`;
  }

  function updateTags(){
    const cat = category.value;
    const diff = Number(difficulty.value);
    tagCat.textContent = cat;
    tagDiff.textContent = `d${diff}`;
    tagMode.textContent = mode;
  }

  // Share link encoding
  function encodePrompt(p){
    const payload = {cat:p.cat, diff:p.diff, text:p.text, mode};
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    return b64.replaceAll("=","");
  }
  function decodePrompt(str){
    try{
      const pad = str + "===".slice((str.length % 4) || 4);
      const json = decodeURIComponent(escape(atob(pad)));
      const obj = JSON.parse(json);
      if (!obj || !obj.text) return null;
      return obj;
    } catch { return null; }
  }

  function setPrompt(p, reason=""){
    current = p;
    promptText.textContent = p.text;               // FIX: always visible
    promptSub.textContent = reason || "Log it below when you’re done.";
    updateTags();

    // animate
    const box = promptText.closest(".prompt");
    box.classList.remove("pulse");
    void box.offsetWidth;
    box.classList.add("pulse");

    // URL
    const u = new URL(location.href);
    u.searchParams.set("c", encodePrompt(p));
    history.replaceState(null, "", u.toString());
  }

  function pool(){
    const cat = category.value;
    const diff = Number(difficulty.value);

    const custom = loadCustom().map(t => ({cat:"custom", diff, text:t}));
    const base = prompts.slice();

    let list = [];
    if (cat === "custom"){
      list = custom;
    } else if (cat === "any"){
      list = base.concat(custom);
    } else {
      list = base.filter(p => p.cat === cat).concat(cat === "any" ? custom : []);
    }

    // If custom selected but empty, fall back to base any
    if (cat === "custom" && list.length === 0){
      list = base.concat(custom);
    }

    // Prefer exact diff if possible; else keep category-based
    const exact = list.filter(p => p.diff === diff);
    return exact.length ? exact : list;
  }

  function pickRandomNoRepeat(){
    const list = pool();
    if (!list.length) return {cat:"any", diff:Number(difficulty.value), text:"Add some custom prompts or switch categories."};

    const hist = loadHistory();
    const recent = new Set(hist.slice(-18)); // prevent repeats across last 18 spins

    // try multiple times to avoid repeats
    for (let i=0;i<24;i++){
      const p = list[Math.floor(Math.random() * list.length)];
      if (!recent.has(promptId(p))){
        // store
        hist.push(promptId(p));
        saveHistory(hist.slice(-60));
        return p;
      }
    }

    // if pool too small, allow repeat
    const fallback = list[Math.floor(Math.random() * list.length)];
    hist.push(promptId(fallback));
    saveHistory(hist.slice(-60));
    return fallback;
  }

  function pickTodays(){
    const list = pool();
    if (!list.length) return {cat:"any", diff:Number(difficulty.value), text:"Add some custom prompts or switch categories."};
    const seedStr = `${dayKey()}|${category.value}|${difficulty.value}`;
    const idx = seededIndex(list.length, seedStr);
    return list[idx];
  }

  // Streak updates only on days with at least one rejection
  function bumpStreakOnRejection(){
    const today = dayKey();
    const last = localStorage.getItem(K_LAST_REJ_DAY);
    let streak = loadStreak();

    if (!last){
      streak = 1;
    } else {
      const lastDate = new Date(last + "T00:00:00");
      const todayDate = new Date(today + "T00:00:00");
      const diff = Math.round((todayDate - lastDate) / 86400000);

      if (diff === 0){
        // already counted today
      } else if (diff === 1){
        streak += 1;
      } else {
        streak = 1;
      }
    }

    localStorage.setItem(K_LAST_REJ_DAY, today);
    saveStreak(streak);
  }

  function setStreakHint(){
    const today = dayKey();
    const last = localStorage.getItem(K_LAST_REJ_DAY);
    if (!last) { streakHint.textContent = "Log 1 rejection today to start."; return; }
    if (last === today) { streakHint.textContent = "Counted today. Nice."; return; }

    const lastDate = new Date(last + "T00:00:00");
    const todayDate = new Date(today + "T00:00:00");
    const diff = Math.round((todayDate - lastDate) / 86400000);

    streakHint.textContent = (diff === 1)
      ? "Log 1 rejection today to extend."
      : "Streak resets unless you log a rejection today.";
  }

  // XP / quests / badges
  function xpFor(entry){
    const base = entry.result === "rejected" ? 28 : 12;
    const diffBonus = entry.diff * 7;
    const catBonus = (entry.cat === "career" || entry.cat === "negotiation") ? 6 : 0;
    return base + diffBonus + catBonus;
  }

  function unlockBadge(id, name){
    const g = loadGame();
    if (!g.badges[id]){
      g.badges[id] = {name, at: nowISO()};
      saveGame(g);
      toastMsg(`Badge unlocked: ${name}`);
    }
  }

  function buildQuests(){
    const today = dayKey();
    const g = loadGame();
    if (g.questDay === today && g.quests?.length) return;

    const cats = ["social","help","food","career","negotiation","weird"];
    const catPick = cats[seededIndex(cats.length, "q|" + today)];
    g.questDay = today;
    g.quests = [
      {id:"q_no", title:"Get 1 rejection", desc:"Log at least one rejection today.", reward:70},
      {id:"q_cat", title:`Try ${catPick}`, desc:"Log any result in the category of the day.", reward:45, cat:catPick},
      {id:"q_hard", title:"Do a 4 or 5", desc:"Log any result at difficulty 4 or 5.", reward:55}
    ];
    g.questDone = g.questDone || {};
    saveGame(g);
  }

  function checkQuests(){
    buildQuests();
    const g = loadGame();
    const today = dayKey();
    const key = (qid) => `${today}:${qid}`;
    const logs = loadLogs().filter(l => (l.time||"").slice(0,10) === today);

    function grant(qid, amount){
      if (g.questDone[key(qid)]) return false;
      g.questDone[key(qid)] = true;
      g.xp += amount;
      saveGame(g);
      toastMsg(`Quest complete: +${amount} XP`);
      return true;
    }

    if (logs.some(l => l.result === "rejected")) grant("q_no", 70);

    const qCat = g.quests.find(q => q.id === "q_cat")?.cat;
    if (qCat && logs.some(l => l.cat === qCat)) grant("q_cat", 45);

    if (logs.some(l => Number(l.diff) >= 4)) grant("q_hard", 55);
  }

  function renderGame(){
    buildQuests();
    const g = loadGame();
    const lv = levelFromXP(g.xp);
    levelEl.textContent = String(lv.level);
    xpEl.textContent = String(g.xp);
    xpBar.style.width = `${Math.min(100, Math.round((lv.into / lv.need) * 100))}%`;

    // quests
    const today = dayKey();
    const doneKey = (qid) => `${today}:${qid}`;
    questsEl.innerHTML = g.quests.map(q => {
      const done = !!g.questDone?.[doneKey(q.id)];
      return `
        <div style="padding:12px;border-radius:16px;background:rgba(0,0,0,.18);border:1px solid var(--line);display:flex;justify-content:space-between;gap:10px">
          <div>
            <div style="font-weight:900">${escapeHtml(q.title)}</div>
            <div class="muted2" style="font-size:12px;margin-top:4px;line-height:1.35">
              ${escapeHtml(q.desc)} <span class="tag" style="margin-left:6px">+${q.reward} XP</span>
            </div>
          </div>
          <div class="tag" style="min-width:70px;text-align:center">${done ? "done" : "open"}</div>
        </div>
      `;
    }).join("");

    // badges
    const earned = Object.values(g.badges || {});
    badgeCountEl.textContent = String(earned.length);

    const all = [
      {id:"b_first", name:"First No"},
      {id:"b_3", name:"3-day streak"},
      {id:"b_10", name:"10 logs"},
      {id:"b_neg5", name:"Negotiator"},
      {id:"b_career5", name:"Networker"}
    ];
    badgesEl.innerHTML = all.map(b => {
      const have = !!g.badges?.[b.id];
      return `<span class="tag" style="opacity:${have ? 1 : .45}">${escapeHtml(b.name)}</span>`;
    }).join("");
  }

  // Confetti (simple + fast)
  function confettiBurst(){
    const canvas = $("confetti");
    const ctx = canvas.getContext("2d");
    const W = canvas.width = window.innerWidth;
    const H = canvas.height = window.innerHeight;
    canvas.style.display = "block";

    const pieces = [];
    const N = 160;
    for (let i=0;i<N;i++){
      pieces.push({
        x: Math.random()*W,
        y: -20 - Math.random()*H*0.2,
        r: 3 + Math.random()*5,
        vx: (-1 + Math.random()*2) * 2.2,
        vy: 2.4 + Math.random()*4.4,
        a: Math.random()*Math.PI*2,
        va: (-1 + Math.random()*2) * 0.2,
        life: 120 + Math.random()*40
      });
    }

    let t = 0;
    function tick(){
      t++;
      ctx.clearRect(0,0,W,H);

      for (const p of pieces){
        p.x += p.vx;
        p.y += p.vy;
        p.a += p.va;
        p.vy += 0.02;
        p.life -= 1;

        // warm confetti
        const warm = ["rgba(255,122,89,.95)","rgba(255,184,107,.95)","rgba(79,216,162,.9)","rgba(255,90,122,.9)"];
        ctx.fillStyle = warm[(Math.random()*warm.length)|0];
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(p.a);
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*1.3);
        ctx.restore();
      }

      if (t < 130){
        requestAnimationFrame(tick);
      } else {
        canvas.style.display = "none";
      }
    }
    requestAnimationFrame(tick);
  }

  // Render logs + stats
  function renderLogs(){
    const logs = loadLogs();
    totalEl.textContent = String(logs.length);

    const rej = logs.filter(l => l.result === "rejected").length;
    rateEl.textContent = logs.length ? `${Math.round((rej/logs.length)*100)}%` : "0%";

    streakEl.textContent = String(loadStreak());
    setStreakHint();

    if (!logs.length){
      logBody.innerHTML = `<tr><td colspan="3" class="muted">No logs yet.</td></tr>`;
      return;
    }

    const rows = logs.slice().reverse().slice(0, 12).map(l => {
      const dt = new Date(l.time);
      const when = dt.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      const res = l.result === "rejected" ? "Rejected" : "Accepted";
      const meta = `
        <div class="miniMeta">
          <span class="tag">${escapeHtml(l.cat)}</span>
          <span class="tag">d${escapeHtml(String(l.diff))}</span>
          ${l.where ? `<span class="tag">where: ${escapeHtml(l.where)}</span>` : ""}
          ${l.who ? `<span class="tag">who: ${escapeHtml(l.who)}</span>` : ""}
        </div>
      `;
      const extra = l.note ? `<div class="muted2" style="margin-top:6px;line-height:1.35">${escapeHtml(l.note)}</div>` : "";
      return `
        <tr>
          <td>${escapeHtml(when)}</td>
          <td>
            <div style="font-weight:900">${escapeHtml(l.text)}</div>
            ${meta}
            ${extra}
          </td>
          <td>${res}</td>
        </tr>
      `;
    }).join("");

    logBody.innerHTML = rows;
  }

  // Logging
  function logResult(result){
    if (!current || !current.text){
      toastMsg("Spin a prompt first.");
      return;
    }

    const entry = {
      time: nowISO(),
      result,
      cat: current.cat || category.value,
      diff: Number(current.diff || difficulty.value),
      text: current.text,
      where: where.value.trim(),
      who: who.value.trim(),
      note: note.value.trim()
    };

    const logs = loadLogs();
    logs.push(entry);
    saveLogs(logs);

    // streak only on rejection
    if (result === "rejected") bumpStreakOnRejection();

    // XP
    const g = loadGame();
    g.xp += xpFor(entry);
    saveGame(g);

    // badges
    if (logs.some(l => l.result === "rejected")) unlockBadge("b_first", "First No");
    if (loadStreak() >= 3) unlockBadge("b_3", "3-day streak");
    if (logs.length >= 10) unlockBadge("b_10", "10 logs");
    if (logs.filter(l => l.cat === "negotiation").length >= 5) unlockBadge("b_neg5", "Negotiator");
    if (logs.filter(l => l.cat === "career").length >= 5) unlockBadge("b_career5", "Networker");

    // quests
    checkQuests();

    // clear inputs
    where.value = ""; who.value = ""; note.value = "";

    renderLogs();
    renderGame();

    if (result === "rejected"){
      confettiBurst();
      toastMsg("Logged: rejected. That’s the point.");
    } else {
      toastMsg("Logged: accepted.");
    }
  }

  // Share / export / reset
  async function copyPromptLink(){
    if (!current) { toastMsg("Spin a prompt first."); return; }
    const url = location.href;
    try{
      await navigator.clipboard.writeText(url);
      toastMsg("Link copied.");
    } catch {
      prompt("Copy this link:", url);
    }
  }

  async function shareApp(){
    const url = location.origin + location.pathname;
    try{
      await navigator.clipboard.writeText(url);
      toastMsg("App link copied.");
    } catch {
      prompt("Copy this app link:", url);
    }
  }

  function exportCSV(){
    const logs = loadLogs();
    if (!logs.length){ toastMsg("Nothing to export."); return; }
    const header = ["time_iso","result","category","difficulty","prompt","where","who","note"];
    const rows = logs.map(l => [
      l.time, l.result, l.cat, String(l.diff),
      (l.text||"").replaceAll('"','""'),
      (l.where||"").replaceAll('"','""'),
      (l.who||"").replaceAll('"','""'),
      (l.note||"").replaceAll('"','""')
    ]);
    const csv = [header.join(","), ...rows.map(r => r.map(v => `"${v}"`).join(","))].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rejection-challenge-logs.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function resetAll(){
    if (!confirm("Reset your local logs, streak, XP, badges, quests, custom prompts, and spin history?")) return;
    localStorage.removeItem(K_LOGS);
    localStorage.removeItem(K_STREAK);
    localStorage.removeItem(K_LAST_REJ_DAY);
    localStorage.removeItem(K_GAME);
    localStorage.removeItem(K_CUSTOM);
    localStorage.removeItem(K_HISTORY);

    current = null;
    mode = "random";
    promptText.textContent = "Spin to get your first prompt.";
    promptSub.textContent = "Log it below when you’re done.";

    renderLogs();
    renderGame();
    updateCustomCount();
    toastMsg("Reset complete.");
  }

  // Custom prompts actions
  function addCustom(){
    const val = (customInput.value || "").trim();
    if (!val){ toastMsg("Type a prompt first."); return; }
    const list = loadCustom();
    list.push(val);
    saveCustom(list.slice(-200));
    customInput.value = "";
    updateCustomCount();
    toastMsg("Custom prompt added.");
  }

  function viewCustom(){
    const list = loadCustom();
    if (!list.length){ toastMsg("No custom prompts yet."); return; }
    alert("Your custom prompts:\n\n" + list.map((t,i)=>`${i+1}. ${t}`).join("\n"));
  }

  function clearCustom(){
    if (!confirm("Clear all custom prompts?")) return;
    localStorage.removeItem(K_CUSTOM);
    updateCustomCount();
    toastMsg("Custom prompts cleared.");
  }

  // Spin / today
  function spin(which){
    mode = which;
    updateTags();

    const p = (which === "today") ? pickTodays() : pickRandomNoRepeat();
    setPrompt(p, which === "today" ? "Same for everyone today (with your filters)." : "New spin. Go get it.");
  }

  // Wire events
  difficulty.addEventListener("input", () => {
    setCompass(difficulty.value);
    // Changing diff should not lock you into same prompt; next spin will avoid repeats.
    updateTags();
  });

  category.addEventListener("change", () => {
    updateTags();
    toastMsg("Filter set. Spin when ready.");
  });

  spinBtn.addEventListener("click", () => spin("random"));
  todaysBtn.addEventListener("click", () => spin("today"));
  spinTopBtn.addEventListener("click", () => { location.hash = "#tracker"; setTimeout(()=>spin("random"), 80); });
  todaysTopBtn.addEventListener("click", () => { location.hash = "#tracker"; setTimeout(()=>spin("today"), 80); });

  acceptedBtn.addEventListener("click", () => logResult("accepted"));
  rejectedBtn.addEventListener("click", () => logResult("rejected"));

  copyPromptLinkBtn.addEventListener("click", copyPromptLink);
  shareBtn.addEventListener("click", shareApp);
  exportBtn.addEventListener("click", exportCSV);
  resetBtn.addEventListener("click", resetAll);

  addCustomBtn.addEventListener("click", addCustom);
  viewCustomBtn.addEventListener("click", viewCustom);
  clearCustomBtn.addEventListener("click", clearCustom);
  customInput.addEventListener("keydown", (e)=>{ if (e.key === "Enter") addCustom(); });

  document.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === "g") spin("random");
    if (k === "t") spin("today");
    if (k === "r") logResult("rejected");
  });

  // Load from shared prompt link
  const params = new URLSearchParams(location.search);
  const c = params.get("c");
  if (c){
    const decoded = decodePrompt(c);
    if (decoded){
      // apply
      category.value = ["food","social","help","negotiation","weird","career","custom","any"].includes(decoded.cat) ? decoded.cat : "any";
      difficulty.value = String(Math.min(5, Math.max(1, parseInt(decoded.diff||3,10) || 3)));
      setCompass(difficulty.value);
      mode = decoded.mode === "today" ? "today" : "random";
      setPrompt({cat:decoded.cat, diff:Number(difficulty.value), text:decoded.text}, "Loaded from link.");
    }
  }

  // Initial render
  setCompass(difficulty.value);
  updateTags();
  renderLogs();
  renderGame();
  updateCustomCount();
})();
</script>
</body>
</html>
