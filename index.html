<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rejection Challenge</title>
  <meta name="description" content="Spin a prompt. Do it in person. Log reps. Streak, XP, combos, boss challenges. No login." />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Fraunces:opsz,wght@9..144,650;9..144,760&family=Inter:wght@400;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">

  <!-- html2canvas (for copy/download prompt card as image) -->
  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg0:#120a07;
      --bg1:#1a0f0a;

      --text:#fff6f0;
      --muted:rgba(255,246,240,.72);

      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --border: rgba(255,255,255,.14);

      --accent:#ff6f4c;   /* warm coral */
      --accent2:#ffb36a;  /* warm amber */
      --good:#38d39f;     /* mint */
      --bad:#ff5575;      /* rose */
      --ink: rgba(0,0,0,.22);

      --shadow: 0 18px 60px rgba(0,0,0,.48);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);

      --r: 22px;
      --sans: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      --serif: Fraunces, ui-serif, Georgia, serif;
      --mono: JetBrains Mono, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1000px 620px at 8% 0%, rgba(255,111,76,.30), transparent 60%),
        radial-gradient(1000px 620px at 100% 10%, rgba(255,179,106,.22), transparent 58%),
        radial-gradient(800px 520px at 30% 110%, rgba(56,211,159,.14), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:1120px; margin:0 auto; padding:26px 16px 64px}

    header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      margin-bottom:16px;
    }
    .brand{display:flex; flex-direction:column; gap:8px}
    .brandTop{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap}
    .name{
      font-family:var(--serif);
      font-weight:760;
      letter-spacing:.2px;
      font-size:28px;
      line-height:1.05;
    }
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      font-family:var(--mono);
      font-size:12px;
      padding:4px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:rgba(255,246,240,.86);
      white-space:nowrap;
    }
    .tagline{
      color:var(--muted);
      max-width:78ch;
      line-height:1.45;
      font-size:14px;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end}

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      header{flex-direction:column}
      .actions{justify-content:flex-start}
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.05));
      border-radius: var(--r);
      box-shadow: var(--shadow2);
      padding:16px;
      overflow:hidden;
    }
    .cardTitle{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin:0 0 10px;
    }
    h2{
      margin:0;
      font-size:14px;
      letter-spacing:.18px;
      color:rgba(255,246,240,.92);
    }
    .muted{color:var(--muted)}
    .small{font-size:12px; line-height:1.45}
    .mono{font-family:var(--mono)}

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.07);
      color:var(--text);
      border-radius: 14px;
      padding:10px 12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .18s ease, background .18s ease;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
    }
    .btn:hover{filter:brightness(1.05)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.slim{padding:9px 10px; font-size:13px; box-shadow:none}
    .btn.ghost{background:rgba(255,255,255,.04); box-shadow:none}
    .btn.primary{
      background: linear-gradient(90deg, rgba(255,111,76,.95), rgba(255,179,106,.85));
      border-color: rgba(255,179,106,.26);
    }
    .btn.good{
      background: linear-gradient(90deg, rgba(56,211,159,.92), rgba(56,211,159,.62));
      border-color: rgba(56,211,159,.30);
    }
    .btn.bad{
      background: linear-gradient(90deg, rgba(255,85,117,.92), rgba(255,85,117,.62));
      border-color: rgba(255,85,117,.30);
    }

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1 1 auto}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    select, input[type="range"], input[type="text"], textarea{
      width:100%;
      border-radius:14px;
      padding:10px 12px;
      border:1px solid rgba(255,255,255,.14);
      background: var(--ink);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:84px; resize:vertical}

    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color:rgba(255,246,240,.88);
      white-space:nowrap;
    }

    /* Prompt + wheel zone */
    .arena{
      display:grid;
      grid-template-columns: 340px 1fr;
      gap:14px;
      align-items:start;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .arena{grid-template-columns:1fr}
    }

    .wheelWrap{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(700px 260px at 0% 0%, rgba(255,111,76,.18), transparent 60%),
        radial-gradient(700px 260px at 100% 0%, rgba(255,179,106,.14), transparent 60%),
        rgba(0,0,0,.18);
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .wheelTop{
      display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .wheelStage{
      position:relative;
      width: 100%;
      aspect-ratio: 1/1;
      display:grid;
      place-items:center;
    }
    .pointer{
      position:absolute;
      top:-2px;
      left:50%;
      transform:translateX(-50%);
      width:0;height:0;
      border-left:10px solid transparent;
      border-right:10px solid transparent;
      border-bottom:16px solid rgba(255,246,240,.92);
      filter: drop-shadow(0 10px 10px rgba(0,0,0,.25));
      z-index:2;
    }
    .wheel{
      width:100%;
      height:100%;
      border-radius:50%;
      border:1px solid rgba(255,255,255,.18);
      box-shadow: inset 0 0 0 10px rgba(0,0,0,.10), 0 18px 40px rgba(0,0,0,.28);
      overflow:hidden;
      position:relative;
      transform: rotate(0deg);
      transition: transform 850ms cubic-bezier(.12,.95,.14,1);
    }
    .wheel::after{
      content:"";
      position:absolute; inset:18%;
      border-radius:50%;
      background: radial-gradient(circle at 30% 20%, rgba(255,255,255,.16), rgba(0,0,0,.16));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 16px 30px rgba(0,0,0,.18);
    }
    .wheelCenter{
      position:absolute;
      inset:33%;
      border-radius:50%;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.16);
      display:grid;
      place-items:center;
      text-align:center;
      padding:10px;
      z-index:1;
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
    }
    .wheelCenter .big{
      font-family:var(--serif);
      font-weight:760;
      font-size:14px;
      letter-spacing:.1px;
      line-height:1.15;
    }
    .wheelCenter .mini{
      font-family:var(--mono);
      margin-top:6px;
      font-size:11px;
      color:rgba(255,246,240,.76);
    }

    .sliceLabel{
      position:absolute;
      width:100%;
      height:100%;
      pointer-events:none;
    }
    .sliceLabel span{
      position:absolute;
      left:50%;
      top:50%;
      transform-origin: 0 0;
      font-family:var(--mono);
      font-size:11px;
      color:rgba(255,246,240,.90);
      text-shadow: 0 8px 14px rgba(0,0,0,.35);
      letter-spacing:.1px;
      white-space:nowrap;
    }

    .promptBox{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(900px 260px at 0% 0%, rgba(255,111,76,.18), transparent 60%),
        radial-gradient(900px 260px at 100% 0%, rgba(255,179,106,.14), transparent 60%),
        rgba(0,0,0,.18);
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .promptMeta{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .promptPills{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .promptText{
      font-size:20px;
      line-height:1.24;
      margin:10px 0 6px;
      font-weight:850;
      letter-spacing:.1px;
      opacity:.95;
      transform: translateY(2px);
      transition: opacity .18s ease, transform .18s ease;
      min-height: 54px;
    }
    .promptText.show{opacity:1; transform:translateY(0)}
    .hint{font-size:12px; color:var(--muted)}

    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.14);
      padding:10px 12px;
      border-radius:999px;
      box-shadow: var(--shadow2);
      display:none;
      z-index:9999;
      max-width:min(92vw, 720px);
      text-align:center;
      font-size:13px;
      backdrop-filter: blur(10px);
    }

    /* Progress + gamification */
    .statGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-top:10px}
    @media (max-width: 520px){ .statGrid{grid-template-columns:1fr} }
    .stat{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
    }
    .k{font-size:11px; color:var(--muted)}
    .v{font-size:20px; font-weight:900; margin-top:4px}

    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      margin-top:10px;
    }
    .bar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(255,111,76,.95), rgba(255,179,106,.88));
    }

    .combo{
      margin-top:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      padding:12px;
    }
    .comboTop{display:flex; justify-content:space-between; gap:10px; align-items:baseline; flex-wrap:wrap}
    .comboBig{font-family:var(--serif); font-weight:760; letter-spacing:.1px}
    .comboMult{font-family:var(--mono); font-size:12px; color:rgba(255,246,240,.85)}
    .comboBar{margin-top:10px}
    .comboBar > div{
      background: linear-gradient(90deg, rgba(56,211,159,.92), rgba(255,179,106,.86));
    }

    .badgeRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

    /* Boss */
    .bossCard{
      margin-top:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(800px 280px at 0% 0%, rgba(56,211,159,.14), transparent 60%),
        radial-gradient(800px 280px at 100% 0%, rgba(255,111,76,.16), transparent 60%),
        rgba(0,0,0,.18);
      padding:14px;
      box-shadow: var(--shadow2);
    }

    /* Post prompt card */
    .postCard{
      margin-top:12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(900px 360px at 0% 0%, rgba(255,111,76,.22), transparent 60%),
        radial-gradient(900px 360px at 100% 0%, rgba(255,179,106,.18), transparent 60%),
        rgba(0,0,0,.18);
      padding:14px;
      box-shadow: var(--shadow2);
    }
    .shareCanvas{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.20);
      padding:14px;
    }
    .shareHeader{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start;
      margin-bottom:10px;
    }
    .shareTitle{
      font-family:var(--serif);
      font-weight:760;
      letter-spacing:.1px;
    }
    .sharePrompt{
      font-size:18px;
      font-weight:850;
      line-height:1.25;
      margin:8px 0 10px;
    }
    .shareFooter{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color:rgba(255,246,240,.78);
      font-family:var(--mono);
      font-size:11px;
    }

    table{width:100%; border-collapse:collapse; margin-top:10px; font-size:13px}
    th,td{padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.08); vertical-align:top}
    th{color:var(--muted); font-weight:800; font-size:12px; text-align:left}

    details{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.14);
      border-radius: 16px;
      padding:12px;
      margin-top:12px;
    }
    summary{cursor:pointer; font-weight:850; list-style:none}
    summary::-webkit-details-marker{display:none}

    @media print{
      header,.actions,.toast,details,.postCard{display:none !important}
      body{background:#fff !important; color:#000 !important}
      .card,.wheelWrap,.promptBox,.bossCard{box-shadow:none !important; background:#fff !important; border:1px solid #ddd !important}
      .muted{color:#333 !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="brandTop">
          <div class="name">Rejection Challenge</div>
          <div class="chips">
            <span class="chip">public</span>
            <span class="chip">no login</span>
            <span class="chip">logs are local</span>
          </div>
        </div>
        <div class="tagline">Spin a prompt. Do it in person. Log it. Level up. Repeat.</div>
      </div>

      <div class="actions">
        <button class="btn slim" id="copyAppBtn" title="Copy app link">Copy app link</button>
        <button class="btn slim" id="exportBtn" title="Export your logs as CSV">Export CSV</button>
        <button class="btn slim" id="resetBtn" title="Reset logs, streak, XP, boss">Reset</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT -->
      <div class="card">
        <div class="cardTitle">
          <h2>Prompt roulette</h2>
          <div class="row" style="flex:0 0 auto">
            <button class="btn slim ghost" id="modeDailyBtn" title="Same prompt for everyone today">Daily</button>
            <button class="btn slim ghost" id="modeRandomBtn" title="Variety mode">Random</button>
          </div>
        </div>

        <div class="row">
          <div style="min-width:220px">
            <label for="category">Category</label>
            <select id="category">
              <option value="any">Any</option>
              <option value="food">Food / cafe</option>
              <option value="social">Social</option>
              <option value="help">Ask for help</option>
              <option value="negotiation">Negotiation</option>
              <option value="weird">Wholesome weird</option>
              <option value="career">Career</option>
            </select>
          </div>

          <div style="min-width:220px">
            <label for="difficulty">Difficulty <span class="pill" id="diffPill">3</span></label>
            <input id="difficulty" type="range" min="1" max="5" value="3" />
          </div>

          <div style="min-width:220px">
            <label for="variety">Variety helper</label>
            <select id="variety">
              <option value="smart" selected>Smart (avoid repeats)</option>
              <option value="strict">Strict (filters must match)</option>
            </select>
          </div>
        </div>

        <div class="arena">
          <!-- Wheel -->
          <div class="wheelWrap">
            <div class="wheelTop">
              <div class="row" style="gap:8px; flex: 1 1 auto">
                <span class="pill mono" id="wheelModePill">mode: random</span>
                <span class="pill mono" id="wheelFilterPill">smart variety</span>
              </div>
              <button class="btn primary" id="spinBtn" title="Spin (Space)">Spin</button>
            </div>

            <div class="wheelStage">
              <div class="pointer" aria-hidden="true"></div>
              <div class="wheel" id="wheel" aria-label="Category wheel"></div>
              <div class="wheelCenter" aria-hidden="true">
                <div class="big" id="wheelCenterTitle">Spin</div>
                <div class="mini" id="wheelCenterSub">Space</div>
              </div>
              <div class="sliceLabel" id="sliceLabels"></div>
            </div>

            <div class="small muted" style="margin-top:10px">
              Tip: If you keep the same filters, Smart mode will rotate through options instead of repeating.
            </div>
          </div>

          <!-- Prompt + logging -->
          <div>
            <div class="promptBox" id="promptBox">
              <div class="promptMeta">
                <div class="promptPills">
                  <span class="pill mono" id="modePill">mode: random</span>
                  <span class="pill mono" id="catPill">cat: any</span>
                  <span class="pill mono" id="dPill">d3</span>
                </div>
                <div class="row" style="flex:0 0 auto">
                  <button class="btn slim ghost" id="copyPromptLinkBtn">Copy prompt link</button>
                </div>
              </div>

              <div class="promptText" id="promptText">Spin to roll a prompt.</div>
              <div class="hint">Shortcuts: Space = spin, R = log rejected, A = log accepted</div>
            </div>

            <details>
              <summary>How it works (tap)</summary>
              <div class="small muted" style="margin-top:8px; line-height:1.55">
                Do one prompt in person. Log accepted or rejected.
                Your streak only moves on days you log at least one rejection.
                Logs are saved only in your browser — visitors do not share logs.
              </div>
            </details>

            <div class="row" style="margin-top:12px">
              <div style="min-width:220px">
                <label for="where">Where (optional)</label>
                <input id="where" type="text" placeholder="coffee shop, campus, gym" />
              </div>
              <div style="min-width:220px">
                <label for="who">Who (optional)</label>
                <input id="who" type="text" placeholder="barista, classmate, stranger" />
              </div>
            </div>

            <div style="margin-top:10px">
              <label for="note">Note (optional)</label>
              <textarea id="note" placeholder="One line: what happened?"></textarea>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="btn good" id="acceptBtn">Accepted</button>
              <button class="btn bad" id="rejectBtn">Rejected</button>
            </div>

            <!-- Post prompt -->
            <div class="postCard">
              <div class="cardTitle" style="margin:0 0 10px">
                <h2>Post this prompt</h2>
                <div class="pill mono" id="shareStamp">ready</div>
              </div>

              <div id="shareCard" class="shareCanvas">
                <div class="shareHeader">
                  <div>
                    <div class="shareTitle">Rejection Challenge</div>
                    <div class="small muted" id="shareMeta">mode: random • cat: any • d3</div>
                  </div>
                  <div class="pill mono" id="shareWeek">week</div>
                </div>

                <div class="sharePrompt" id="sharePrompt">Spin to get a prompt.</div>

                <div class="shareFooter">
                  <span class="pill">in person</span>
                  <span class="pill">be polite</span>
                  <span class="pill" id="shareUrlShort">open the link</span>
                </div>
              </div>

              <div class="row" style="margin-top:10px">
                <button class="btn slim" id="copyImageBtn">Copy image</button>
                <button class="btn slim" id="downloadImageBtn">Download PNG</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card">
        <div class="cardTitle">
          <h2>Progress</h2>
          <span class="pill mono">local only</span>
        </div>

        <div class="statGrid">
          <div class="stat">
            <div class="k">Streak (days)</div>
            <div class="v" id="streak">0</div>
          </div>
          <div class="stat">
            <div class="k">Level</div>
            <div class="v" id="level">1</div>
          </div>
          <div class="stat">
            <div class="k">XP</div>
            <div class="v" id="xp">0</div>
          </div>
        </div>

        <div class="bar" aria-label="XP progress">
          <div id="xpFill"></div>
        </div>
        <div class="small muted" id="xpText" style="margin-top:8px">0 / 100 to next level</div>

        <!-- Combo -->
        <div class="combo">
          <div class="comboTop">
            <div>
              <div class="comboBig">Combo</div>
              <div class="small muted">More reps today = bonus XP</div>
            </div>
            <div class="comboMult" id="comboText">x1.00</div>
          </div>
          <div class="bar comboBar" aria-label="Combo progress">
            <div id="comboFill"></div>
          </div>
          <div class="small muted" style="margin-top:8px" id="comboHint">Do 1 rep to start a combo.</div>
        </div>

        <!-- Badges -->
        <div class="card" style="margin-top:12px">
          <div class="cardTitle" style="margin:0 0 10px">
            <h2>Badges</h2>
            <span class="pill mono">unlocked locally</span>
          </div>
          <div class="badgeRow" id="badges"></div>
        </div>

        <!-- Boss -->
        <div class="bossCard">
          <div class="cardTitle" style="margin:0 0 10px">
            <h2>Weekly boss</h2>
            <span class="pill mono" id="bossWeekPill">week</span>
          </div>

          <div class="row" style="gap:8px; margin-bottom:10px">
            <span class="pill mono" id="bossMeta">boss</span>
            <span class="pill mono" id="bossReward">+0 XP</span>
          </div>

          <div class="promptText show" id="bossText" style="font-size:18px; min-height:auto">Loading boss...</div>

          <div class="row" style="margin-top:10px">
            <button class="btn slim" id="loadBossBtn">Load into prompt</button>
            <button class="btn slim primary" id="markBossBtn">Mark completed</button>
          </div>

          <div class="small muted" style="margin-top:10px" id="bossHint">One bigger ask per week.</div>
        </div>

        <!-- Logs -->
        <div class="card" style="margin-top:12px">
          <div class="cardTitle" style="margin:0 0 10px">
            <h2>Recent logs</h2>
            <span class="pill mono">only you see this</span>
          </div>

          <div style="overflow:auto">
            <table>
              <thead>
                <tr>
                  <th style="min-width:130px">Time</th>
                  <th>Prompt</th>
                  <th style="min-width:110px">Result</th>
                </tr>
              </thead>
              <tbody id="logBody">
                <tr><td colspan="3" class="muted">No logs yet.</td></tr>
              </tbody>
            </table>
          </div>

          <div class="row" style="margin-top:10px">
            <div class="stat" style="flex:1 1 auto">
              <div class="k">Total logs</div>
              <div class="v" id="total">0</div>
            </div>
            <div class="stat" style="flex:1 1 auto">
              <div class="k">Rejection rate</div>
              <div class="v" id="rate">0%</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    (() => {
      const $ = (id) => document.getElementById(id);

      // UI
      const category = $("category");
      const difficulty = $("difficulty");
      const variety = $("variety");

      const diffPill = $("diffPill");
      const modePill = $("modePill");
      const catPill = $("catPill");
      const dPill = $("dPill");

      const wheelModePill = $("wheelModePill");
      const wheelFilterPill = $("wheelFilterPill");

      const modeDailyBtn = $("modeDailyBtn");
      const modeRandomBtn = $("modeRandomBtn");

      const spinBtn = $("spinBtn");
      const wheel = $("wheel");
      const sliceLabels = $("sliceLabels");
      const wheelCenterTitle = $("wheelCenterTitle");
      const wheelCenterSub = $("wheelCenterSub");

      const promptBox = $("promptBox");
      const promptText = $("promptText");
      const copyPromptLinkBtn = $("copyPromptLinkBtn");

      const where = $("where");
      const who = $("who");
      const note = $("note");
      const acceptBtn = $("acceptBtn");
      const rejectBtn = $("rejectBtn");

      const copyAppBtn = $("copyAppBtn");
      const exportBtn = $("exportBtn");
      const resetBtn = $("resetBtn");

      const streakEl = $("streak");
      const levelEl = $("level");
      const xpEl = $("xp");
      const xpFill = $("xpFill");
      const xpText = $("xpText");

      const comboText = $("comboText");
      const comboFill = $("comboFill");
      const comboHint = $("comboHint");

      const badgesEl = $("badges");

      const bossWeekPill = $("bossWeekPill");
      const bossMeta = $("bossMeta");
      const bossReward = $("bossReward");
      const bossText = $("bossText");
      const bossHint = $("bossHint");
      const loadBossBtn = $("loadBossBtn");
      const markBossBtn = $("markBossBtn");

      const logBody = $("logBody");
      const totalEl = $("total");
      const rateEl = $("rate");
      const toast = $("toast");

      const shareCard = $("shareCard");
      const sharePrompt = $("sharePrompt");
      const shareMeta = $("shareMeta");
      const shareWeek = $("shareWeek");
      const shareUrlShort = $("shareUrlShort");
      const shareStamp = $("shareStamp");
      const copyImageBtn = $("copyImageBtn");
      const downloadImageBtn = $("downloadImageBtn");

      // Storage keys
      const LOGS_KEY = "rej_logs_v2";
      const STREAK_KEY = "rej_streak_v2";
      const LAST_REJ_DAY_KEY = "rej_last_rej_day_v2";

      const GAME_KEY = "rej_game_v2";
      const DECK_KEY = "rej_deck_v2"; // anti-repeat deck by filter key

      const BOSS_KEY = "rej_boss_v2";

      // State
      let mode = "random"; // default to random to avoid "same prompt" confusion
      let current = null;

      // Categories (wheel segments)
      const CATS = [
        {key:"food", label:"food", color:"#ffb36a"},
        {key:"social", label:"social", color:"#ff6f4c"},
        {key:"help", label:"help", color:"#38d39f"},
        {key:"negotiation", label:"deal", color:"#ff5575"},
        {key:"weird", label:"weird", color:"#b7a1ff"},
        {key:"career", label:"career", color:"#7dd3ff"}
      ];

      // Prompts: multiple per cat+diff so strict filters can still vary
      // (This is the key fix: strict used to have "1 prompt" pools.)
      const PROMPTS = [];
      function add(cat,diff,texts){ texts.forEach(t => PROMPTS.push({id: cat+"_"+diff+"_"+hash32(t), cat, diff, text:t})); }

      add("food",1,[
        "Ask for a recommendation that is not the top seller.",
        "Ask if there is a favorite item the staff orders.",
        "Ask what they would order if they had to choose one thing."
      ]);
      add("food",2,[
        "Ask if they can make your order less sweet.",
        "Ask if they can do half syrup (or lighter seasoning).",
        "Ask if there is a milder or less sweet version."
      ]);
      add("food",3,[
        "Ask for a small swap (side or topping).",
        "Ask if they can change one ingredient (if possible).",
        "Ask if they can leave one ingredient out."
      ]);
      add("food",4,[
        "Ask them to pick a surprise under $5 and go with it.",
        "Ask them to choose something you would not normally pick.",
        "Ask for a surprise recommendation and commit to it."
      ]);
      add("food",5,[
        "Ask for a small extra (ice, sauce, topping). If no, say thanks and move on.",
        "Ask if they can throw in a small add-on. If no, end it politely.",
        "Ask if they can upgrade the size once. If no, accept it and leave it there."
      ]);

      add("social",1,[
        "Give a sincere compliment to someone and leave.",
        "Tell someone one specific thing you like (then walk away).",
        "Compliment something small (shoes, jacket, hair) and keep moving."
      ]);
      add("social",2,[
        "Ask someone where they got something you like.",
        "Ask what brand something is because you like it.",
        "Ask if they would recommend where they bought it."
      ]);
      add("social",3,[
        "Ask someone to rate your outfit from 1 to 10.",
        "Ask someone: does my haircut look fine today? Quick answer.",
        "Ask a stranger: am I giving more 'coffee' or 'tea' energy today?"
      ]);
      add("social",4,[
        "Ask a stranger to take a quick photo of you.",
        "Ask someone to take a quick picture and offer to return the favor.",
        "Ask someone to take a photo and give them a simple thank you."
      ]);
      add("social",5,[
        "Ask a group if you can join for 60 seconds to practice small talk, then leave.",
        "Ask someone to introduce you to one person nearby (if appropriate).",
        "Ask a table if you can ask one quick question for a class project (then leave)."
      ]);

      add("help",1,[
        "Ask for directions to a place you already know.",
        "Ask someone which way is north (even if you know).",
        "Ask where the nearest restroom is (even if you already found it)."
      ]);
      add("help",2,[
        "Ask for a nearby spot they genuinely like.",
        "Ask what coffee shop they would recommend nearby.",
        "Ask what they would do in the area if they had one hour."
      ]);
      add("help",3,[
        "Ask to borrow a pen for 30 seconds.",
        "Ask if someone has a charger you can use for one minute.",
        "Ask if they can hold your seat for 30 seconds."
      ]);
      add("help",4,[
        "Ask someone to help you pick between two options and say why.",
        "Ask for a quick recommendation between two items and follow it.",
        "Ask an employee to recommend one option and commit to it."
      ]);
      add("help",5,[
        "Ask someone to listen to a 10-second intro and give one improvement.",
        "Ask someone for one blunt tip on how you come across.",
        "Ask for one quick piece of feedback on your voice/energy (10 seconds)."
      ]);

      add("negotiation",1,[
        "Ask if there is a student discount.",
        "Ask if there is any discount or deal today.",
        "Ask if there is a cheaper option for the same thing."
      ]);
      add("negotiation",2,[
        "Ask if a fee can be waived once.",
        "Ask if they can remove one small fee if you do not need it.",
        "Ask if there is a promo or discount code you can use."
      ]);
      add("negotiation",3,[
        "Ask for a small upgrade (size, add-on, seat).",
        "Ask if they can do a small add-on for free this time.",
        "Ask for a tiny upgrade and accept no without pushing."
      ]);
      add("negotiation",4,[
        "Ask for a small discount ($1–$2) on a small purchase.",
        "Ask if they can match a posted price (if applicable).",
        "Ask if they can round down the price. If no, end it."
      ]);
      add("negotiation",5,[
        "Ask for a free add-on. If no, thank them and end it.",
        "Ask if they can throw in something small. If no, you stop.",
        "Ask if they can waive an upgrade fee once. If no, accept it."
      ]);

      add("weird",1,[
        "Ask someone a harmless silly question: which animal runs this city?",
        "Ask someone: what is the most underrated snack?",
        "Ask someone: if today had a soundtrack, what is the first song?"
      ]);
      add("weird",2,[
        "Ask a cashier: is today more of a 7 or a 9?",
        "Ask someone: are you having a 6 day or an 8 day?",
        "Ask someone: quick vote, sunrise or sunset?"
      ]);
      add("weird",3,[
        "Ask for a 10-second pep talk.",
        "Ask someone to say one encouraging sentence.",
        "Ask someone: what is one thing you would tell your past self?"
      ]);
      add("weird",4,[
        "Ask for one life hack that saves time.",
        "Ask someone: what is one habit that changed your life?",
        "Ask someone: what is one thing you do to stay calm?"
      ]);
      add("weird",5,[
        "Ask for a 5-second voice note saying 'you’ve got this' (only if they’re comfortable).",
        "Ask someone to record one line of advice (only if they’re comfortable).",
        "Ask someone to do a 3-second 'good luck' clip (only if they want)."
      ]);

      add("career",1,[
        "Ask what someone does for work and what they enjoy about it.",
        "Ask what they are working on lately (one question).",
        "Ask what skill matters most in their role."
      ]);
      add("career",2,[
        "Ask for one piece of advice for someone early in their career.",
        "Ask what mistake most beginners make in their field.",
        "Ask what they would learn if they started over."
      ]);
      add("career",3,[
        "Ask if they’d be open to a 10-minute coffee chat sometime.",
        "Ask if you can ask one quick question about their path.",
        "Ask if they can share one tip on breaking into their space."
      ]);
      add("career",4,[
        "Ask if they know one person you should meet and why.",
        "Ask for one recommendation of who to learn from.",
        "Ask if there is one event or group you should join."
      ]);
      add("career",5,[
        "Ask a professional for one blunt improvement for your intro.",
        "Ask for one brutal tip on your presence (10 seconds).",
        "Ask for one thing to change in how you introduce yourself."
      ]);

      // Utils
      const dayKey = (d=new Date()) => d.toISOString().slice(0,10);

      function toastMsg(msg){
        toast.textContent = msg;
        toast.style.display = "block";
        clearTimeout(toast._t);
        toast._t = setTimeout(()=> toast.style.display="none", 1600);
      }

      function hash32(str){
        let h = 2166136261;
        for (let i=0;i<str.length;i++){
          h ^= str.charCodeAt(i);
          h = Math.imul(h, 16777619);
        }
        return h >>> 0;
      }

      function base64urlEncode(obj){
        const json = JSON.stringify(obj);
        const b64 = btoa(unescape(encodeURIComponent(json)));
        return b64.replaceAll("+","-").replaceAll("/","_").replaceAll("=","");
      }

      function base64urlDecode(str){
        try{
          const padLen = (4 - (str.length % 4)) % 4;
          const padded = str + "=".repeat(padLen);
          const b64 = padded.replaceAll("-","+").replaceAll("_","/");
          const json = decodeURIComponent(escape(atob(b64)));
          return JSON.parse(json);
        }catch{
          return null;
        }
      }

      function loadLogs(){
        try{ return JSON.parse(localStorage.getItem(LOGS_KEY) || "[]"); }
        catch{ return []; }
      }
      function saveLogs(x){ localStorage.setItem(LOGS_KEY, JSON.stringify(x)); }

      function loadStreak(){
        try{ return JSON.parse(localStorage.getItem(STREAK_KEY) || "0"); }
        catch{ return 0; }
      }
      function saveStreak(n){ localStorage.setItem(STREAK_KEY, JSON.stringify(n)); }

      function loadGame(){
        try{
          return JSON.parse(localStorage.getItem(GAME_KEY) || "null") || {xp:0, badges:{}, comboDay:null, comboCount:0, bossDoneWeek:null};
        }catch{
          return {xp:0, badges:{}, comboDay:null, comboCount:0, bossDoneWeek:null};
        }
      }
      function saveGame(g){ localStorage.setItem(GAME_KEY, JSON.stringify(g)); }

      function loadDecks(){
        try{ return JSON.parse(localStorage.getItem(DECK_KEY) || "{}"); }
        catch{ return {}; }
      }
      function saveDecks(d){ localStorage.setItem(DECK_KEY, JSON.stringify(d)); }

      function xpToLevel(xp){
        let level = 1;
        let need = 100;
        let spent = 0;
        while(xp >= spent + need){
          spent += need;
          level++;
          need = Math.floor(need * 1.22) + 30;
        }
        return {level, into: xp - spent, need};
      }

      function isoWeekKey(date = new Date()){
        const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
        const dayNum = d.getUTCDay() || 7;
        d.setUTCDate(d.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        return `${d.getUTCFullYear()}-W${String(weekNo).padStart(2,"0")}`;
      }

      // Filters + variety behavior
      function setMeta(){
        diffPill.textContent = difficulty.value;
        modePill.textContent = "mode: " + mode;
        catPill.textContent = "cat: " + category.value;
        dPill.textContent = "d" + difficulty.value;

        wheelModePill.textContent = "mode: " + mode;
        wheelFilterPill.textContent = (variety.value === "smart") ? "smart variety" : "strict";
      }

      // Build pool with smart widening to avoid "same prompt forever"
      function poolSmart(){
        const cat = category.value;
        const d = parseInt(difficulty.value, 10);
        const strict = (variety.value === "strict");

        const exact = PROMPTS.filter(p => (cat==="any" || p.cat===cat) && p.diff===d);
        if (strict) return exact;

        // Smart widening: if exact is too small, widen gradually
        if (exact.length >= 3) return exact;

        // widen 1: if cat is specific, allow same cat across all diffs
        let widened = [];
        if (cat !== "any"){
          widened = PROMPTS.filter(p => p.cat===cat);
        } else {
          // if cat is any, allow all cats at that difficulty
          widened = PROMPTS.filter(p => p.diff===d);
        }
        if (widened.length >= 4) return widened;

        // widen 2: allow all prompts (full variety)
        return PROMPTS.slice();
      }

      // Non-repeat deck per filter key
      function filterKey(){
        return `${mode}|${category.value}|${difficulty.value}|${variety.value}`;
      }

      function shuffle(arr){
        for (let i=arr.length-1; i>0; i--){
          const j = Math.floor(Math.random()*(i+1));
          [arr[i],arr[j]] = [arr[j],arr[i]];
        }
        return arr;
      }

      function nextFromDeck(list){
        const key = filterKey();
        const decks = loadDecks();
        let deck = decks[key];

        if (!Array.isArray(deck) || deck.length === 0){
          deck = shuffle(list.map(p => p.id));
        }

        // Avoid immediate repetition with current
        if (current && deck.length > 1 && deck[0] === current.id){
          const idx = deck.findIndex(x => x !== current.id);
          if (idx > 0){
            const picked = deck.splice(idx,1)[0];
            deck.unshift(picked);
          }
        }

        const id = deck.shift();
        decks[key] = deck;
        saveDecks(decks);

        return list.find(p => p.id === id) || list[Math.floor(Math.random()*list.length)];
      }

      function pickDailyPrompt(list){
        const seed = dayKey() + "|" + category.value + "|" + difficulty.value + "|" + variety.value;
        const idx = hash32(seed) % list.length;
        // Daily is deterministic, but still respects smart widening.
        return list[idx];
      }

      function makePromptLink(p){
        const url = new URL(location.href);
        url.searchParams.set("p", base64urlEncode({
          id: p.id, cat:p.cat, diff:p.diff, text:p.text, mode, v: variety.value
        }));
        return url.toString();
      }

      function updateShareCard(p){
        shareWeek.textContent = isoWeekKey(new Date());
        shareMeta.textContent = `mode: ${mode} • cat: ${p ? p.cat : category.value} • d${p ? p.diff : difficulty.value}`;
        sharePrompt.textContent = p ? p.text : "Spin to get a prompt.";
        shareUrlShort.textContent = "open the link";
        shareStamp.textContent = p ? "ready" : "empty";
      }

      function showPrompt(p, reason){
        current = p;

        promptText.classList.remove("show");
        requestAnimationFrame(() => {
          promptText.textContent = p.text;
          promptText.classList.add("show");
          promptBox.scrollIntoView({behavior:"smooth", block:"center"});
        });

        // Update URL for sharing prompt
        const url = new URL(location.href);
        url.searchParams.set("p", base64urlEncode({id:p.id, cat:p.cat, diff:p.diff, text:p.text, mode, v: variety.value}));
        history.replaceState(null, "", url.toString());

        updateShareCard(p);

        if (reason) toastMsg(reason);
      }

      // Wheel rendering
      function renderWheel(){
        // Build a conic gradient wheel by categories
        const parts = CATS.map((c,i) => {
          const start = (i / CATS.length) * 100;
          const end = ((i+1) / CATS.length) * 100;
          return `${c.color} ${start}% ${end}%`;
        }).join(", ");
        wheel.style.background = `conic-gradient(${parts})`;

        // Labels around wheel
        sliceLabels.innerHTML = "";
        const radius = 130;
        for (let i=0;i<CATS.length;i++){
          const angle = (i / CATS.length) * 360 - 90 + (180 / CATS.length);
          const span = document.createElement("span");
          span.textContent = CATS[i].label;
          span.style.transform = `translate(-50%,-50%) rotate(${angle}deg) translate(${radius}px) rotate(${90}deg)`;
          sliceLabels.appendChild(span);
        }
      }

      // Wheel spin mechanics
      let wheelAngle = 0;
      let spinning = false;

      function landedCategoryFromAngle(angle){
        // Pointer at top. Determine segment index where pointer lands.
        const normalized = ((angle % 360) + 360) % 360;
        // At 0deg wheel rotation, pointer is at top. Conic starts at 0deg to the right;
        // We'll map using pointer reference: top is -90deg in standard circle.
        // We'll convert pointer angle to "conic angle" by adding 90.
        const pointerConic = (360 - normalized + 90) % 360;
        const segment = Math.floor(pointerConic / (360 / CATS.length));
        return CATS[Math.min(CATS.length-1, Math.max(0, segment))].key;
      }

      function spin(){
        if (spinning) return;

        spinning = true;
        wheelCenterTitle.textContent = "Spinning";
        wheelCenterSub.textContent = "hold";

        // Choose rotation: 4-7 turns + random
        const turns = 4 + Math.floor(Math.random()*4);
        const extra = Math.floor(Math.random()*360);
        const target = wheelAngle + turns*360 + extra;

        wheelAngle = target;
        wheel.style.transform = `rotate(${wheelAngle}deg)`;

        setTimeout(() => {
          const landedCat = landedCategoryFromAngle(wheelAngle);

          // If user chose "Any", let the wheel influence category for this spin (more fun).
          // If they chose a specific category, keep it as is.
          const originalCat = category.value;
          const useWheelCat = (originalCat === "any");
          if (useWheelCat) category.value = landedCat;

          setMeta();

          const list = poolSmart();
          if (!list.length){
            spinning = false;
            toastMsg("No prompts found.");
            return;
          }

          let picked;
          if (mode === "daily"){
            picked = pickDailyPrompt(list);
          } else {
            picked = nextFromDeck(list);
          }

          // Restore category if wheel was only a temporary influencer
          if (useWheelCat) {
            // keep the landed category (it feels better than snapping back)
            // If you want it to snap back, uncomment next line:
            // category.value = originalCat;
          }

          wheelCenterTitle.textContent = "Done";
          wheelCenterSub.textContent = "log it";
          showPrompt(picked, "Prompt ready.");

          spinning = false;
        }, 900);
      }

      // Streak (only updated on days with at least one rejection)
      function updateRejStreak(){
        const today = dayKey();
        const last = localStorage.getItem(LAST_REJ_DAY_KEY);
        let streak = loadStreak();

        if(!last){
          streak = 1;
        }else{
          const lastDate = new Date(last + "T00:00:00");
          const todayDate = new Date(today + "T00:00:00");
          const diffDays = Math.round((todayDate - lastDate) / 86400000);

          if(diffDays === 0){
            // already counted today
          }else if(diffDays === 1){
            streak += 1;
          }else{
            streak = 1;
          }
        }
        localStorage.setItem(LAST_REJ_DAY_KEY, today);
        saveStreak(streak);
      }

      // Combo system: counts logs per day. Bonus XP multiplier rises with each rep today.
      function getComboMultiplier(g){
        const today = dayKey();
        if (g.comboDay !== today) return 1.0;
        const c = g.comboCount || 0;
        // starts at 1.00 then +0.10 per extra rep, capped at 1.60
        return Math.min(1.60, 1.0 + Math.max(0, c-1)*0.10);
      }

      function bumpCombo(g){
        const today = dayKey();
        if (g.comboDay !== today){
          g.comboDay = today;
          g.comboCount = 1;
        } else {
          g.comboCount = (g.comboCount || 0) + 1;
        }
      }

      function xpForLog(result, p){
        const base = (result === "rejected") ? 28 : 14;
        const diffBonus = (p.diff * 8);
        const catBonus = (p.cat === "career" || p.cat === "negotiation") ? 8 : 0;
        return base + diffBonus + catBonus;
      }

      function awardXP(amount, reason){
        const g = loadGame();
        const beforeLevel = xpToLevel(g.xp).level;

        // combo multiplier
        const mult = getComboMultiplier(g);
        const final = Math.round(amount * mult);

        g.xp += final;
        saveGame(g);

        const afterLevel = xpToLevel(g.xp).level;
        if (afterLevel > beforeLevel){
          toastMsg(`Level up: ${beforeLevel} -> ${afterLevel}`);
        } else if (reason){
          toastMsg(`${reason}: +${final} XP`);
        }
      }

      function unlockBadge(id, name){
        const g = loadGame();
        if (!g.badges[id]){
          g.badges[id] = {name, at: new Date().toISOString()};
          saveGame(g);
          toastMsg("Badge unlocked: " + name);
        }
      }

      function renderBadges(){
        const g = loadGame();
        const all = [
          {id:"first_no", name:"First No"},
          {id:"streak_3", name:"Three-day streak"},
          {id:"logs_10", name:"Ten reps"},
          {id:"boss_week", name:"Boss cleared"},
          {id:"neg_5", name:"Negotiator"},
          {id:"career_5", name:"Networker"},
          {id:"combo_4", name:"Combo 4"}
        ];
        badgesEl.innerHTML = all.map(b => {
          const owned = !!g.badges[b.id];
          return `<span class="pill mono" style="opacity:${owned?1:.38}">${b.name}</span>`;
        }).join("");
      }

      // Boss system
      function bossForWeek(){
        const week = isoWeekKey(new Date());
        const pool = PROMPTS.filter(p => p.diff >= 4 && (p.cat === "career" || p.cat === "negotiation" || p.cat === "social"));
        const idx = hash32("boss|" + week) % pool.length;
        const p = pool[idx];
        const reward = 220 + p.diff * 45;
        return {week, prompt:p, reward};
      }

      function loadBossUI(){
        const b = bossForWeek();
        bossWeekPill.textContent = b.week;
        bossMeta.textContent = `boss • ${b.prompt.cat} • d${b.prompt.diff}`;
        bossReward.textContent = `+${b.reward} XP`;

        const g = loadGame();
        const done = (g.bossDoneWeek === b.week);
        bossText.textContent = done ? (b.prompt.text + " (completed)") : b.prompt.text;
        bossHint.textContent = done ? "Boss done. New boss next week." : "One bigger ask per week. High reward.";

        loadBossBtn.onclick = () => {
          // Load boss into prompt
          category.value = b.prompt.cat;
          difficulty.value = String(b.prompt.diff);
          setMeta();
          showPrompt(b.prompt, "Boss loaded.");
        };

        markBossBtn.onclick = () => {
          const gg = loadGame();
          if (gg.bossDoneWeek === b.week){
            toastMsg("Boss already completed this week.");
            return;
          }
          gg.bossDoneWeek = b.week;
          saveGame(gg);
          awardXP(b.reward, "Boss cleared");
          unlockBadge("boss_week", "Boss cleared");
          loadBossUI();
          renderAll();
        };
      }

      // Logs rendering
      function renderLogs(){
        const logs = loadLogs();
        if(!logs.length){
          logBody.innerHTML = `<tr><td colspan="3" class="muted">No logs yet.</td></tr>`;
          totalEl.textContent = "0";
          rateEl.textContent = "0%";
          return;
        }

        const rejected = logs.filter(l=>l.result==="rejected").length;
        totalEl.textContent = String(logs.length);
        rateEl.textContent = Math.round((rejected/logs.length)*100) + "%";

        const rows = logs.slice().reverse().slice(0,10).map(l => {
          const when = new Date(l.time).toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
          const res = l.result === "rejected" ? "Rejected" : "Accepted";
          return `<tr><td>${when}</td><td>${escapeHtml(l.text)}</td><td>${res}</td></tr>`;
        }).join("");
        logBody.innerHTML = rows;
      }

      function escapeHtml(s){
        return String(s)
          .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
          .replaceAll('"',"&quot;").replaceAll("'","&#039;");
      }

      // Combo render
      function renderCombo(){
        const g = loadGame();
        const today = dayKey();
        const count = (g.comboDay === today) ? (g.comboCount || 0) : 0;
        const mult = (g.comboDay === today) ? getComboMultiplier(g) : 1.0;

        comboText.textContent = "x" + mult.toFixed(2);

        const pct = Math.min(100, (count / 6) * 100); // 6 reps to fill bar
        comboFill.style.width = pct + "%";

        if (count === 0){
          comboHint.textContent = "Do 1 rep to start a combo.";
        } else {
          comboHint.textContent = `Today: ${count} rep${count===1?"":"s"} • bonus active`;
        }

        if (count >= 4) unlockBadge("combo_4", "Combo 4");
      }

      // Main render
      function renderAll(){
        setMeta();

        streakEl.textContent = String(loadStreak());

        const g = loadGame();
        const lv = xpToLevel(g.xp);
        levelEl.textContent = String(lv.level);
        xpEl.textContent = String(g.xp);

        const pct = Math.round((lv.into / lv.need) * 100);
        xpFill.style.width = pct + "%";
        xpText.textContent = `${lv.into} / ${lv.need} to next level`;

        renderCombo();
        renderBadges();
        renderLogs();
        loadBossUI();

        // share card metadata refresh
        shareWeek.textContent = isoWeekKey(new Date());
        if (!current) updateShareCard(null);
      }

      // Logging
      function log(result){
        if(!current){
          toastMsg("Spin first.");
          return;
        }

        const logs = loadLogs();
        logs.push({
          time: new Date().toISOString(),
          result,
          cat: current.cat,
          diff: current.diff,
          text: current.text,
          where: where.value.trim(),
          who: who.value.trim(),
          note: note.value.trim(),
          mode,
          variety: variety.value
        });
        saveLogs(logs);

        // streak only on rejected
        if (result === "rejected") updateRejStreak();

        // combo bump first, then XP (so multiplier applies)
        const g = loadGame();
        bumpCombo(g);
        saveGame(g);

        const baseXP = xpForLog(result, current);
        awardXP(baseXP, "Logged");

        // Badges based on totals
        const all = loadLogs();
        if (all.some(x => x.result === "rejected")) unlockBadge("first_no", "First No");
        if (loadStreak() >= 3) unlockBadge("streak_3", "Three-day streak");
        if (all.length >= 10) unlockBadge("logs_10", "Ten reps");
        if (all.filter(x => x.cat === "negotiation").length >= 5) unlockBadge("neg_5", "Negotiator");
        if (all.filter(x => x.cat === "career").length >= 5) unlockBadge("career_5", "Networker");

        // clear fields
        where.value = "";
        who.value = "";
        note.value = "";

        renderAll();
      }

      // Export CSV
      function exportCSV(){
        const logs = loadLogs();
        if (!logs.length){
          toastMsg("Nothing to export yet.");
          return;
        }
        const header = ["time_iso","result","mode","variety","category","difficulty","prompt","where","who","note"];
        const rows = logs.map(l => [
          l.time, l.result, l.mode, l.variety, l.cat, l.diff,
          (l.text||"").replaceAll('"','""'),
          (l.where||"").replaceAll('"','""'),
          (l.who||"").replaceAll('"','""'),
          (l.note||"").replaceAll('"','""')
        ].map(x => `"${x}"`).join(","));
        const csv = [header.join(","), ...rows].join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "rejection-challenge-logs.csv";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toastMsg("Exported CSV.");
      }

      // Reset
      function resetAll(){
        if(!confirm("Reset logs, streak, XP, combo, boss, and decks on this device?")) return;
        localStorage.removeItem(LOGS_KEY);
        localStorage.removeItem(STREAK_KEY);
        localStorage.removeItem(LAST_REJ_DAY_KEY);
        localStorage.removeItem(GAME_KEY);
        localStorage.removeItem(DECK_KEY);
        localStorage.removeItem(BOSS_KEY);

        const url = new URL(location.href);
        url.searchParams.delete("p");
        history.replaceState(null, "", url.toString());

        current = null;
        promptText.textContent = "Spin to roll a prompt.";
        promptText.classList.add("show");
        updateShareCard(null);

        renderAll();
        toastMsg("Reset complete.");
      }

      // Copy helpers
      async function copyText(text, okMsg){
        try{
          await navigator.clipboard.writeText(text);
          toastMsg(okMsg);
        }catch{
          prompt("Copy this:", text);
        }
      }

      function copyAppLink(){
        const url = location.origin + location.pathname;
        copyText(url, "App link copied.");
      }

      function copyPromptLink(){
        if(!current){
          toastMsg("Spin first.");
          return;
        }
        copyText(makePromptLink(current), "Prompt link copied.");
      }

      // Post prompt: image
      async function renderShareCardToCanvas(){
        await new Promise(r => setTimeout(r, 50));
        const canvas = await html2canvas(shareCard, {backgroundColor: null, scale: 2});
        return canvas;
      }

      async function copyShareImage(){
        if(!current){
          toastMsg("Spin first.");
          return;
        }
        try{
          const canvas = await renderShareCardToCanvas();
          const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
          if(!blob) throw new Error("no blob");
          if (navigator.clipboard && window.ClipboardItem){
            await navigator.clipboard.write([new ClipboardItem({"image/png": blob})]);
            toastMsg("Copied image.");
          } else {
            toastMsg("Clipboard image not supported here. Use Download PNG.");
          }
        }catch{
          toastMsg("Could not copy image. Try Download PNG.");
        }
      }

      async function downloadShareImage(){
        if(!current){
          toastMsg("Spin first.");
          return;
        }
        const canvas = await renderShareCardToCanvas();
        const url = canvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = "rejection-challenge-prompt.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
        toastMsg("Downloaded PNG.");
      }

      // Mode toggles
      function setMode(next){
        mode = next;
        modeDailyBtn.classList.toggle("primary", mode==="daily");
        modeRandomBtn.classList.toggle("primary", mode==="random");
        setMeta();
        updateShareCard(current);
        toastMsg("Mode: " + mode);
      }

      // Wire events
      spinBtn.addEventListener("click", spin);
      acceptBtn.addEventListener("click", () => log("accepted"));
      rejectBtn.addEventListener("click", () => log("rejected"));

      exportBtn.addEventListener("click", exportCSV);
      resetBtn.addEventListener("click", resetAll);

      copyAppBtn.addEventListener("click", copyAppLink);
      copyPromptLinkBtn.addEventListener("click", copyPromptLink);

      copyImageBtn.addEventListener("click", copyShareImage);
      downloadImageBtn.addEventListener("click", downloadShareImage);

      modeDailyBtn.addEventListener("click", () => setMode("daily"));
      modeRandomBtn.addEventListener("click", () => setMode("random"));

      category.addEventListener("change", () => { setMeta(); });
      difficulty.addEventListener("input", () => { setMeta(); });
      variety.addEventListener("change", () => { setMeta(); });

      // Keyboard shortcuts
      document.addEventListener("keydown", (e) => {
        if (e.code === "Space"){
          e.preventDefault();
          spin();
        }
        const k = e.key.toLowerCase();
        if (k === "r") log("rejected");
        if (k === "a") log("accepted");
      });

      // Load from shared prompt link
      function loadFromUrlIfPresent(){
        const params = new URLSearchParams(location.search);
        const p = params.get("p");
        if (!p) return;

        const obj = base64urlDecode(p);
        if (obj && obj.text){
          mode = (obj.mode === "daily") ? "daily" : "random";
          setMode(mode);

          if (obj.v) variety.value = (obj.v === "strict") ? "strict" : "smart";
          category.value = ["food","social","help","negotiation","weird","career"].includes(obj.cat) ? obj.cat : "any";
          difficulty.value = String(Math.min(5, Math.max(1, parseInt(obj.diff || 3,10) || 3)));

          setMeta();
          const loaded = {id: obj.id || ("loaded_"+hash32(obj.text)), cat: obj.cat, diff: parseInt(obj.diff||3,10), text: obj.text};
          showPrompt(loaded, "Loaded shared prompt.");
        }
      }

      // Init
      renderWheel();
      setMode("random");     // default
      setMeta();
      updateShareCard(null);
      loadFromUrlIfPresent();
      renderAll();
    })();
  </script>
</body>
</html>

