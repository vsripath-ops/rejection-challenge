<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rejection Challenge</title>
  <meta name="description" content="Spin a quick in-person challenge. Log the result. Build a rejection streak. No login." />

  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='16' fill='%23150d0a'/%3E%3Ctext x='50%25' y='58%25' text-anchor='middle' font-family='Arial' font-size='24' fill='%23fff2ea'%3ERC%3C/text%3E%3C/svg%3E">

  <script defer src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --bg:#120807;
      --card:#1a0f0d;
      --text:#fff2ea;
      --muted:rgba(255,242,234,.72);
      --muted2:rgba(255,242,234,.55);

      --accent:#ff7a59;
      --accent2:#ffb86b;
      --mint:#53e2b0;
      --pink:#ff5b85;

      --border:rgba(255,242,234,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:var(--sans); color:var(--text);
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(255,122,89,.35), transparent 60%),
        radial-gradient(900px 520px at 100% 10%, rgba(255,184,107,.22), transparent 55%),
        radial-gradient(700px 420px at 40% 120%, rgba(83,226,176,.12), transparent 60%),
        var(--bg);
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:1120px; margin:0 auto; padding:22px 16px 80px}

    /* Top bar */
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background:
        radial-gradient(18px 18px at 30% 30%, rgba(255,184,107,.55), transparent 70%),
        radial-gradient(18px 18px at 70% 70%, rgba(255,122,89,.45), transparent 70%),
        rgba(255,242,234,.08);
      border:1px solid var(--border);
      box-shadow: var(--shadow2);
    }
    .title{
      font-weight:950; letter-spacing:.2px;
      display:flex; align-items:baseline; gap:10px; flex-wrap:wrap;
    }
    .title .name{font-size:18px}
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:5px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,242,234,.06);
      color:var(--muted);
      white-space:nowrap;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap}

    /* Buttons */
    .btn{
      appearance:none; border:1px solid rgba(255,242,234,.14);
      background:rgba(255,242,234,.08);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .06s ease, filter .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn.small{padding:8px 10px; font-size:13px}
    .btn.primary{
      border-color:rgba(255,184,107,.28);
      background:linear-gradient(90deg, rgba(255,122,89,.95), rgba(255,184,107,.82));
    }
    .btn.good{
      border-color:rgba(83,226,176,.32);
      background:linear-gradient(90deg, rgba(83,226,176,.92), rgba(83,226,176,.62));
    }
    .btn.bad{
      border-color:rgba(255,91,133,.32);
      background:linear-gradient(90deg, rgba(255,91,133,.92), rgba(255,91,133,.62));
    }
    .btn.ghost{
      background:rgba(255,242,234,.06);
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      margin-top:12px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr}
    }

    .card{
      border:1px solid var(--border);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(26,15,13,.92), rgba(26,15,13,.72));
      box-shadow: var(--shadow);
      padding:16px;
    }

    /* Hero */
    .hero{
      border-radius:var(--r);
      border:1px solid rgba(255,242,234,.10);
      background:
        radial-gradient(1200px 420px at 0% 0%, rgba(255,122,89,.22), transparent 60%),
        radial-gradient(1200px 420px at 100% 0%, rgba(255,184,107,.18), transparent 60%),
        rgba(255,242,234,.04);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .heroTop{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .hero h1{
      margin:0;
      font-size:30px;
      line-height:1.08;
      letter-spacing:.2px;
    }
    .hero p{
      margin:8px 0 0;
      color:var(--muted);
      line-height:1.45;
      max-width:64ch;
    }
    .hint{
      color:var(--muted2);
      font-size:12px;
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      border:1px solid rgba(255,242,234,.12);
      background:rgba(255,242,234,.06);
      border-radius:999px;
      padding:6px;
    }
    .chip{
      border:0;
      background:transparent;
      color:var(--muted);
      padding:8px 10px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }
    .chip.on{
      color:var(--text);
      background:rgba(255,242,234,.10);
      border:1px solid rgba(255,242,234,.12);
    }

    /* Wheel */
    .wheelWrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:14px;
      align-items:center;
    }
    @media (max-width: 760px){
      .wheelWrap{grid-template-columns:1fr}
    }

    .wheelBox{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:14px;
      border-radius:var(--r);
      border:1px solid rgba(255,242,234,.10);
      background:rgba(0,0,0,.12);
      position:relative;
      overflow:hidden;
      min-height:280px;
    }
    .pointer{
      position:absolute;
      top:12px;
      left:50%;
      transform:translateX(-50%);
      width:0; height:0;
      border-left:12px solid transparent;
      border-right:12px solid transparent;
      border-top:18px solid rgba(255,242,234,.92);
      filter:drop-shadow(0 10px 10px rgba(0,0,0,.35));
      z-index:3;
    }

    .wheel{
      width:240px; height:240px;
      border-radius:50%;
      border:1px solid rgba(255,242,234,.14);
      box-shadow: inset 0 0 0 8px rgba(0,0,0,.18), var(--shadow2);
      background:
        conic-gradient(
          rgba(255,122,89,.92),
          rgba(255,184,107,.92),
          rgba(83,226,176,.92),
          rgba(255,91,133,.92),
          rgba(255,184,107,.92),
          rgba(255,122,89,.92)
        );
      transform: rotate(0deg);
      transition: transform 1.8s cubic-bezier(.12,.85,.18,1);
    }
    .wheelLabel{
      position:absolute;
      width:240px; height:240px;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding:18px;
      pointer-events:none;
      z-index:2;
    }
    .wheelLabel .inside{
      width:170px;
      border-radius:16px;
      border:1px solid rgba(255,242,234,.14);
      background:rgba(18,8,7,.62);
      box-shadow: var(--shadow2);
      padding:10px 12px;
      font-weight:950;
      line-height:1.25;
    }
    .wheelLabel .inside span{
      display:block;
      margin-top:6px;
      font-size:12px;
      font-weight:800;
      color:var(--muted);
      font-family:var(--mono);
    }

    /* Challenge card */
    .challenge{
      border-radius:var(--r);
      border:1px solid rgba(255,242,234,.12);
      background:
        radial-gradient(900px 260px at 0% 0%, rgba(255,122,89,.14), transparent 60%),
        radial-gradient(900px 260px at 100% 0%, rgba(255,184,107,.12), transparent 60%),
        rgba(0,0,0,.14);
      padding:14px;
    }
    .challengeTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      flex-wrap:wrap;
    }
    .meta{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }
    .tag{
      border:1px solid rgba(255,242,234,.12);
      background:rgba(255,242,234,.06);
      padding:4px 8px;
      border-radius:999px;
    }
    .challengeText{
      margin:10px 0 0;
      font-size:18px;
      font-weight:950;
      letter-spacing:.1px;
      line-height:1.22;
    }
    .mini{
      margin-top:8px;
      color:var(--muted);
      font-size:12px;
    }

    /* Inputs */
    label{display:block; font-size:12px; color:var(--muted); margin:10px 0 6px}
    select, input[type="text"], textarea, input[type="range"]{
      width:100%;
      border-radius:14px;
      border:1px solid rgba(255,242,234,.12);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:88px; resize:vertical}

    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .row > *{flex:1 1 180px}

    /* Stats */
    .statgrid{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    @media (max-width:520px){ .statgrid{grid-template-columns:1fr} }
    .stat{
      border-radius:16px;
      border:1px solid rgba(255,242,234,.10);
      background:rgba(0,0,0,.16);
      padding:12px;
    }
    .stat .k{color:var(--muted); font-size:11px}
    .stat .v{font-weight:950; font-size:20px; margin-top:6px}

    table{width:100%; border-collapse:collapse; font-size:13px; margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,242,234,.08); padding:10px 8px; vertical-align:top}
    th{color:var(--muted); font-size:12px; text-align:left}

    /* Collapsible */
    details{
      border:1px solid rgba(255,242,234,.10);
      border-radius:16px;
      background:rgba(0,0,0,.14);
      padding:10px 12px;
    }
    summary{
      cursor:pointer;
      font-weight:950;
      list-style:none;
    }
    summary::-webkit-details-marker{display:none}
    .smallList{margin:10px 0 0; padding-left:18px; color:var(--muted); line-height:1.5}
    .smallList li{margin:6px 0}

    /* Toast + confetti canvas */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,242,234,.14);
      background:rgba(20,10,8,.85);
      box-shadow: var(--shadow2);
      display:none;
      z-index:9999;
      max-width:min(92vw, 760px);
      text-align:center;
      font-size:13px;
    }
    #confetti{
      position:fixed; inset:0;
      pointer-events:none;
      z-index:9998;
    }

    /* First-time modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9997;
    }
    .modal{
      width:min(560px, 96vw);
      border-radius:20px;
      border:1px solid rgba(255,242,234,.14);
      background:
        radial-gradient(800px 320px at 0% 0%, rgba(255,122,89,.18), transparent 60%),
        radial-gradient(800px 320px at 100% 0%, rgba(255,184,107,.14), transparent 60%),
        rgba(26,15,13,.92);
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modal h3{margin:0; font-size:16px}
    .modal p{margin:8px 0 0; color:var(--muted); line-height:1.45}
    .modal .bul{
      margin:10px 0 0;
      padding-left:18px;
      color:var(--muted);
      line-height:1.5;
    }
    .modal .bul li{margin:6px 0}
    .modal .row{margin-top:12px}

  </style>
</head>

<body>
  <canvas id="confetti"></canvas>

  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div class="title">
          <span class="name">Rejection Challenge</span>
          <span class="pill">public</span>
          <span class="pill">no login</span>
          <span class="pill">fast</span>
        </div>
      </div>
      <div class="actions">
        <button class="btn small" id="exportBtn" title="Download CSV of your logs">Export</button>
        <button class="btn small" id="shareBtn" title="Share the app link">Share</button>
        <button class="btn small" id="resetBtn" title="Clear everything">Reset</button>
      </div>
    </div>

    <div class="hero">
      <div class="heroTop">
        <div>
          <h1>Spin a dare. Do it in person. Log it.</h1>
          <p>
            The “no” is the win. One small ask a day. Your streak only moves when you log a rejection.
          </p>
          <div class="hint">
            <span class="pill">Tip: keep it polite, quick, and safe</span>
            <details>
              <summary>How it works</summary>
              <ul class="smallList">
                <li>Pick Daily or Random.</li>
                <li>Spin to get a prompt.</li>
                <li>Do it in person (no means stop).</li>
                <li>Log Accepted or Rejected.</li>
              </ul>
            </details>
          </div>
        </div>

        <div class="toggle" role="group" aria-label="Mode toggle">
          <button class="chip on" id="modeDaily">Daily</button>
          <button class="chip" id="modeRandom">Random</button>
        </div>
      </div>

      <div class="wheelWrap">
        <div class="wheelBox">
          <div class="pointer" aria-hidden="true"></div>
          <div class="wheel" id="wheel"></div>
          <div class="wheelLabel">
            <div class="inside" id="wheelInside">
              Spin for a prompt
              <span id="wheelSub">Daily = same for everyone today</span>
            </div>
          </div>
        </div>

        <div class="challenge">
          <div class="challengeTop">
            <div class="meta">
              <span class="tag" id="mCat">category: any</span>
              <span class="tag" id="mDiff">difficulty: 3</span>
              <span class="tag" id="mMode">mode: daily</span>
            </div>
            <div class="row" style="flex:0 0 auto">
              <button class="btn small" id="copyLinkBtn">Copy link</button>
              <button class="btn primary" id="spinBtn">Spin</button>
            </div>
          </div>

          <div class="challengeText" id="challengeText">Your prompt will show up here.</div>
          <div class="mini" id="miniHint">Then log the result below.</div>

          <div class="row" style="margin-top:10px">
            <div>
              <label for="category">Category</label>
              <select id="category">
                <option value="any" selected>Any</option>
                <option value="food">Food / cafe</option>
                <option value="social">Social</option>
                <option value="help">Ask for help</option>
                <option value="negotiation">Negotiation</option>
                <option value="weird">Wholesome weird</option>
                <option value="career">Career</option>
              </select>
            </div>
            <div>
              <label for="difficulty">Difficulty</label>
              <input id="difficulty" type="range" min="1" max="5" value="3" />
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div>
              <label for="where">Where (optional)</label>
              <input id="where" type="text" placeholder="coffee shop, campus, gym" />
            </div>
            <div>
              <label for="who">Who (optional)</label>
              <input id="who" type="text" placeholder="barista, stranger, classmate" />
            </div>
          </div>

          <label for="note">Note (optional)</label>
          <textarea id="note" placeholder="Quick detail. Keep it short."></textarea>

          <div class="row" style="margin-top:10px">
            <button class="btn good" id="acceptedBtn">Accepted</button>
            <button class="btn bad" id="rejectedBtn">Rejected</button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="statgrid">
          <div class="stat">
            <div class="k">Rejection streak (days)</div>
            <div class="v" id="streak">0</div>
          </div>
          <div class="stat">
            <div class="k">Level</div>
            <div class="v" id="level">1</div>
          </div>
          <div class="stat">
            <div class="k">XP</div>
            <div class="v" id="xp">0</div>
          </div>
        </div>

        <details style="margin-top:12px">
          <summary>Rules (quick)</summary>
          <ul class="smallList">
            <li>In person only.</li>
            <li>No means stop. No pushback.</li>
            <li>Skip anything unsafe / weird in your setting.</li>
            <li>Ask for consent for photos/video.</li>
          </ul>
        </details>

        <div style="margin-top:12px">
          <h3 style="margin:0; font-size:14px">Recent logs</h3>
          <table>
            <thead>
              <tr>
                <th style="min-width:160px">Time</th>
                <th>Prompt</th>
                <th style="min-width:110px">Result</th>
              </tr>
            </thead>
            <tbody id="logBody">
              <tr><td colspan="3" style="color:var(--muted)">No logs yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0; font-size:14px">Share card</h3>
        <div style="color:var(--muted); font-size:12px; margin-top:6px">
          Generate a prompt, then export an image.
        </div>

        <div id="shareCard" style="
          margin-top:12px;
          border-radius:18px;
          border:1px solid rgba(255,242,234,.12);
          background:
            radial-gradient(900px 320px at 0% 0%, rgba(255,122,89,.20), transparent 60%),
            radial-gradient(900px 320px at 100% 0%, rgba(255,184,107,.16), transparent 60%),
            rgba(0,0,0,.14);
          padding:14px;
        ">
          <div style="display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start">
            <div style="font-weight:950">Rejection Challenge</div>
            <div class="pill" id="shareStamp">daily</div>
          </div>
          <div style="margin-top:10px; font-weight:950; font-size:18px; line-height:1.25" id="shareText">
            Spin to get a prompt.
          </div>
          <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; color:var(--muted); font-family:var(--mono); font-size:12px">
            <span class="tag" id="shareCat">category:any</span>
            <span class="tag" id="shareDiff">d3</span>
            <span class="tag">rule:no means stop</span>
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button class="btn small" id="copyImgBtn">Copy image</button>
          <button class="btn small" id="downloadImgBtn">Download</button>
        </div>
      </div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true" aria-label="Quick start">
    <div class="modal">
      <h3>Quick start</h3>
      <p>Spin once. Do the ask in person. Log the outcome. That’s it.</p>
      <ul class="bul">
        <li>Rejected counts for streak.</li>
        <li>Keep it polite and fast.</li>
        <li>Skip anything that feels unsafe.</li>
      </ul>
      <div class="row">
        <button class="btn primary" id="modalGo">Got it</button>
        <button class="btn ghost" id="modalSkip">Do not show again</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  // UI
  const modeDaily = $("modeDaily");
  const modeRandom = $("modeRandom");
  const spinBtn = $("spinBtn");
  const wheel = $("wheel");

  const category = $("category");
  const difficulty = $("difficulty");

  const challengeText = $("challengeText");
  const mCat = $("mCat");
  const mDiff = $("mDiff");
  const mMode = $("mMode");

  const where = $("where");
  const who = $("who");
  const note = $("note");

  const acceptedBtn = $("acceptedBtn");
  const rejectedBtn = $("rejectedBtn");

  const exportBtn = $("exportBtn");
  const shareBtn = $("shareBtn");
  const resetBtn = $("resetBtn");
  const copyLinkBtn = $("copyLinkBtn");

  const streakEl = $("streak");
  const levelEl = $("level");
  const xpEl = $("xp");
  const logBody = $("logBody");
  const toast = $("toast");

  const shareCard = $("shareCard");
  const shareStamp = $("shareStamp");
  const shareText = $("shareText");
  const shareCat = $("shareCat");
  const shareDiff = $("shareDiff");
  const copyImgBtn = $("copyImgBtn");
  const downloadImgBtn = $("downloadImgBtn");

  const modalBack = $("modalBack");
  const modalGo = $("modalGo");
  const modalSkip = $("modalSkip");

  // Storage keys
  const K_LOGS = "rc_logs_v1";
  const K_STREAK = "rc_streak_v1";
  const K_LAST_REJ_DAY = "rc_last_rej_day_v1";
  const K_GAME = "rc_game_v1";
  const K_HIDE_MODAL = "rc_hide_modal_v1";

  // State
  let mode = "daily"; // daily | random
  let current = null;

  // Helpers
  function dayKey(d = new Date()){
    return d.toISOString().slice(0,10);
  }
  function toastMsg(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(toast._t);
    toast._t = setTimeout(() => toast.style.display = "none", 1800);
  }
  function hash32(str){
    let h = 2166136261;
    for (let i=0;i<str.length;i++){
      h ^= str.charCodeAt(i);
      h = Math.imul(h, 16777619);
    }
    return h >>> 0;
  }
  function seededIndex(n, seed){
    const s = hash32(seed);
    const x = (Math.imul(s, 1664525) + 1013904223) >>> 0;
    return n ? (x % n) : 0;
  }

  function loadJSON(key, fallback){
    try { return JSON.parse(localStorage.getItem(key) || "null") ?? fallback; }
    catch { return fallback; }
  }
  function saveJSON(key, value){
    localStorage.setItem(key, JSON.stringify(value));
  }

  // Content
  const challenges = [
    {cat:"food", diff:1, text:"Ask the barista to recommend something that is not on the menu."},
    {cat:"food", diff:2, text:"Ask if they can make your drink less sweet."},
    {cat:"food", diff:3, text:"Ask for a surprise under $5 and let them pick."},
    {cat:"food", diff:4, text:"Ask for a small customization (swap a side). If no, say thanks and move on."},
    {cat:"food", diff:5, text:"Ask for a small free add-on. If no, smile and end it."},

    {cat:"social", diff:1, text:"Give a sincere compliment to a stranger and walk away."},
    {cat:"social", diff:2, text:"Ask someone where they got an item because you like it."},
    {cat:"social", diff:3, text:"Ask a stranger to rate your outfit 1–10. Thank them either way."},
    {cat:"social", diff:4, text:"Ask someone to take a quick photo of you. Offer to return the favor."},
    {cat:"social", diff:5, text:"Ask a group if you can join for 60 seconds to practice small talk, then leave."},

    {cat:"help", diff:1, text:"Ask for directions to a place you already know."},
    {cat:"help", diff:2, text:"Ask someone for a nearby recommendation they actually like."},
    {cat:"help", diff:3, text:"Ask to borrow a pen for 30 seconds."},
    {cat:"help", diff:4, text:"Ask an employee to help you choose between two options and why."},
    {cat:"help", diff:5, text:"Ask someone to hear your 15-second intro and give one note."},

    {cat:"negotiation", diff:1, text:"Ask if there is a student discount."},
    {cat:"negotiation", diff:2, text:"Ask if they can waive a small add-on fee once."},
    {cat:"negotiation", diff:3, text:"Ask for a small upgrade (size, add-on, seat)."},
    {cat:"negotiation", diff:4, text:"Ask for $1–$2 off a small purchase. If no, end it."},
    {cat:"negotiation", diff:5, text:"Ask for a free extra. If no, say thanks and stop."},

    {cat:"weird", diff:1, text:"Ask someone a harmless silly question: do pigeons have a leader?"},
    {cat:"weird", diff:2, text:"Ask a cashier: is today more of a 7 or a 9?"},
    {cat:"weird", diff:3, text:"Ask for a 10-second pep talk. Time it."},
    {cat:"weird", diff:4, text:"Ask someone for one life hack that saves time."},
    {cat:"weird", diff:5, text:"Ask for a 5-second 'you got this' video (only with consent)."},
    
    {cat:"career", diff:1, text:"Ask someone what they do for work and what they like about it."},
    {cat:"career", diff:2, text:"Ask for one piece of advice for someone early in their career."},
    {cat:"career", diff:3, text:"Ask if they are open to a 10-minute coffee chat sometime."},
    {cat:"career", diff:4, text:"Ask if they know one person you should meet and why."},
    {cat:"career", diff:5, text:"Ask a professional for feedback on your 15-second intro, on the spot."}
  ];

  function pool(){
    const cat = category.value;
    const diff = parseInt(difficulty.value, 10);
    let p = challenges.filter(c => c.diff === diff);
    if (cat !== "any") p = p.filter(c => c.cat === cat);
    if (!p.length){
      p = challenges.slice();
      if (cat !== "any") p = p.filter(c => c.cat === cat) || challenges.slice();
    }
    return p.length ? p : challenges.slice();
  }

  function pick(){
    const p = pool();
    if (mode === "daily"){
      const seed = dayKey() + "|" + category.value + "|" + difficulty.value;
      return p[seededIndex(p.length, seed)];
    }
    return p[Math.floor(Math.random() * p.length)];
  }

  // Share link encoding
  function encodeChallenge(ch){
    const payload = {cat: ch.cat, diff: ch.diff, text: ch.text, mode, fCat: category.value, fDiff: difficulty.value};
    const b64 = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
    return b64.replaceAll("=","");
  }
  function decodeChallenge(str){
    try{
      const pad = str + "===".slice((str.length % 4) || 4);
      const json = decodeURIComponent(escape(atob(pad)));
      const obj = JSON.parse(json);
      if (!obj || !obj.text) return null;
      return obj;
    } catch { return null; }
  }

  function syncMeta(){
    mCat.textContent = "category: " + category.value;
    mDiff.textContent = "difficulty: " + difficulty.value;
    mMode.textContent = "mode: " + mode;

    shareStamp.textContent = mode;
    shareCat.textContent = "category:" + category.value;
    shareDiff.textContent = "d" + difficulty.value;
  }

  // Wheel spin (pure fun, still deterministic for daily)
  let spinRotation = 0;
  function spin(){
    const ch = pick();
    current = ch;

    // add rotation
    const extra = 1080 + Math.floor(Math.random() * 720); // 3–5 turns
    spinRotation = (spinRotation + extra) % 3600;
    wheel.style.transform = `rotate(${spinRotation}deg)`;

    // show text slightly after spin begins
    setTimeout(() => {
      challengeText.textContent = ch.text;
      shareText.textContent = ch.text;

      const url = new URL(location.href);
      url.searchParams.set("c", encodeChallenge(ch));
      history.replaceState(null, "", url.toString());

      toastMsg("Prompt ready.");
    }, 650);
  }

  // Logs + game
  function loadLogs(){ return loadJSON(K_LOGS, []); }
  function saveLogs(v){ saveJSON(K_LOGS, v); }

  function loadStreak(){ return loadJSON(K_STREAK, 0); }
  function saveStreak(v){ saveJSON(K_STREAK, v); }

  function loadGame(){
    return loadJSON(K_GAME, {xp:0, level:1});
  }
  function saveGame(g){ saveJSON(K_GAME, g); }

  function levelForXP(xp){
    let lvl = 1, need = 120, spent = 0;
    while (xp >= spent + need){
      spent += need;
      lvl += 1;
      need = Math.floor(need * 1.22) + 25;
    }
    return {level:lvl};
  }

  function confettiBurst(){
    const c = $("confetti");
    const ctx = c.getContext("2d");
    const W = c.width = window.innerWidth;
    const H = c.height = window.innerHeight;

    const parts = Array.from({length: 120}).map(() => ({
      x: Math.random()*W,
      y: -20 - Math.random()*H*0.2,
      r: 3 + Math.random()*4,
      vx: -2 + Math.random()*4,
      vy: 3 + Math.random()*5,
      a: 1,
      spin: -0.2 + Math.random()*0.4
    }));

    let t = 0;
    const colors = ["#ff7a59","#ffb86b","#53e2b0","#ff5b85","#fff2ea"];
    function draw(){
      t++;
      ctx.clearRect(0,0,W,H);
      for (const p of parts){
        p.x += p.vx;
        p.y += p.vy;
        p.vy += 0.03;
        p.a -= 0.006;
        ctx.globalAlpha = Math.max(0,p.a);
        ctx.save();
        ctx.translate(p.x,p.y);
        ctx.rotate(t*p.spin);
        ctx.fillStyle = colors[(Math.random()*colors.length)|0];
        ctx.fillRect(-p.r, -p.r, p.r*2, p.r*2);
        ctx.restore();
      }
      if (parts.some(p => p.a > 0 && p.y < H + 40)) requestAnimationFrame(draw);
      else ctx.clearRect(0,0,W,H);
    }
    draw();
  }

  function updateStreakOnRejection(){
    const today = dayKey();
    const last = localStorage.getItem(K_LAST_REJ_DAY);
    let s = loadStreak();

    if (!last) s = 1;
    else {
      const d0 = new Date(last+"T00:00:00");
      const d1 = new Date(today+"T00:00:00");
      const diff = Math.round((d1 - d0) / 86400000);
      if (diff === 0) { /* no change */ }
      else if (diff === 1) s += 1;
      else s = 1;
    }
    localStorage.setItem(K_LAST_REJ_DAY, today);
    saveStreak(s);
  }

  function awardXP(entry){
    const g = loadGame();
    const base = (entry.result === "rejected") ? 30 : 12;
    const diffBonus = (entry.diff || 3) * 7;
    const catBonus = (entry.cat === "negotiation" || entry.cat === "career") ? 8 : 0;
    const add = base + diffBonus + catBonus;

    const before = g.level;
    g.xp += add;
    g.level = levelForXP(g.xp).level;
    saveGame(g);

    if (g.level > before){
      confettiBurst();
      toastMsg("Level up.");
    } else {
      toastMsg("Logged +" + add + " XP");
    }
  }

  function render(){
    // stats
    streakEl.textContent = loadStreak();
    const g = loadGame();
    levelEl.textContent = g.level;
    xpEl.textContent = g.xp;

    // logs
    const logs = loadLogs().slice().reverse().slice(0, 10);
    if (!logs.length){
      logBody.innerHTML = `<tr><td colspan="3" style="color:var(--muted)">No logs yet.</td></tr>`;
      return;
    }
    logBody.innerHTML = logs.map(l => {
      const dt = new Date(l.time);
      const when = dt.toLocaleString([], {month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"});
      const res = l.result === "rejected" ? "Rejected" : "Accepted";
      return `
        <tr>
          <td>${when}</td>
          <td style="font-weight:800">${l.challenge}</td>
          <td>${res}</td>
        </tr>
      `;
    }).join("");
  }

  function log(result){
    if (!current){
      toastMsg("Spin first.");
      return;
    }
    const logs = loadLogs();
    const entry = {
      time: new Date().toISOString(),
      result,
      mode,
      cat: current.cat,
      diff: current.diff,
      challenge: current.text,
      where: where.value.trim(),
      who: who.value.trim(),
      note: note.value.trim()
    };
    logs.push(entry);
    saveLogs(logs);

    if (result === "rejected") updateStreakOnRejection();
    awardXP(entry);

    where.value = "";
    who.value = "";
    note.value = "";

    render();
  }

  // Export + share
  function exportCSV(){
    const logs = loadLogs();
    if (!logs.length){ toastMsg("Nothing to export."); return; }

    const header = ["time_iso","result","mode","category","difficulty","challenge","where","who","note"];
    const rows = logs.map(l => [
      l.time, l.result, l.mode, l.cat, String(l.diff),
      (l.challenge||"").replaceAll('"','""'),
      (l.where||"").replaceAll('"','""'),
      (l.who||"").replaceAll('"','""'),
      (l.note||"").replaceAll('"','""')
    ]);

    const csv = [header.join(","), ...rows.map(r => r.map(v => `"${v}"`).join(","))].join("\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "rejection-challenge-logs.csv";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  async function shareApp(){
    const url = location.origin + location.pathname;
    if (navigator.share){
      try { await navigator.share({title:"Rejection Challenge", text:"Spin a prompt and log it:", url}); } catch {}
    } else {
      try { await navigator.clipboard.writeText(url); toastMsg("Link copied."); }
      catch { prompt("Copy this link:", url); }
    }
  }

  async function copyLink(){
    const url = location.href;
    try { await navigator.clipboard.writeText(url); toastMsg("Copied."); }
    catch { prompt("Copy:", url); }
  }

  async function renderShareCard(){
    await new Promise(r => setTimeout(r, 30));
    return html2canvas(shareCard, {backgroundColor: null, scale: 2});
  }
  async function copyShareImage(){
    if (!current){ toastMsg("Spin first."); return; }
    try{
      const canvas = await renderShareCard();
      const blob = await new Promise(res => canvas.toBlob(res, "image/png"));
      if (!blob) throw new Error("no blob");

      if (navigator.clipboard && window.ClipboardItem){
        await navigator.clipboard.write([new ClipboardItem({"image/png": blob})]);
        toastMsg("Image copied.");
      } else {
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "rejection-card.png";
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        toastMsg("Downloaded.");
      }
    } catch {
      toastMsg("Could not copy. Try download.");
    }
  }
  async function downloadShareImage(){
    if (!current){ toastMsg("Spin first."); return; }
    const canvas = await renderShareCard();
    const url = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = url;
    a.download = "rejection-card.png";
    document.body.appendChild(a);
    a.click();
    a.remove();
    toastMsg("Downloaded.");
  }

  function resetAll(){
    if (!confirm("Reset logs and stats?")) return;
    localStorage.removeItem(K_LOGS);
    localStorage.removeItem(K_STREAK);
    localStorage.removeItem(K_LAST_REJ_DAY);
    localStorage.removeItem(K_GAME);
    history.replaceState(null,"", location.origin + location.pathname);
    current = null;
    challengeText.textContent = "Your prompt will show up here.";
    shareText.textContent = "Spin to get a prompt.";
    toastMsg("Reset.");
    render();
  }

  // Mode toggle
  function setMode(next){
    mode = next;
    modeDaily.classList.toggle("on", mode === "daily");
    modeRandom.classList.toggle("on", mode === "random");
    $("wheelSub").textContent = (mode === "daily")
      ? "Daily = same for everyone today"
      : "Random = fresh roll each time";
    syncMeta();
    if (current){
      // update URL payload mode without forcing new prompt
      const url = new URL(location.href);
      url.searchParams.set("c", encodeChallenge(current));
      history.replaceState(null, "", url.toString());
    }
  }

  // Wiring
  modeDaily.addEventListener("click", () => { setMode("daily"); modeDaily.classList.add("on"); modeRandom.classList.remove("on"); });
  modeRandom.addEventListener("click", () => { setMode("random"); modeRandom.classList.add("on"); modeDaily.classList.remove("on"); });

  spinBtn.addEventListener("click", spin);
  wheel.addEventListener("click", spin);

  category.addEventListener("change", () => { syncMeta(); });
  difficulty.addEventListener("input", () => { syncMeta(); });

  acceptedBtn.addEventListener("click", () => log("accepted"));
  rejectedBtn.addEventListener("click", () => log("rejected"));

  exportBtn.addEventListener("click", exportCSV);
  shareBtn.addEventListener("click", shareApp);
  resetBtn.addEventListener("click", resetAll);
  copyLinkBtn.addEventListener("click", copyLink);

  copyImgBtn.addEventListener("click", copyShareImage);
  downloadImgBtn.addEventListener("click", downloadShareImage);

  // Shortcuts
  document.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    if (k === " "){ e.preventDefault(); spin(); }
    if (k === "r") log("rejected");
    if (k === "a") log("accepted");
  });

  // First-time modal
  function showModal(){
    if (localStorage.getItem(K_HIDE_MODAL) === "1") return;
    modalBack.style.display = "flex";
  }
  function hideModal(perma){
    modalBack.style.display = "none";
    if (perma) localStorage.setItem(K_HIDE_MODAL, "1");
  }
  modalGo.addEventListener("click", () => hideModal(false));
  modalSkip.addEventListener("click", () => hideModal(true));
  modalBack.addEventListener("click", (e) => { if (e.target === modalBack) hideModal(false); });

  // Load from shared link if present
  const params = new URLSearchParams(location.search);
  const c = params.get("c");
  if (c){
    const decoded = decodeChallenge(c);
    if (decoded){
      mode = (decoded.mode === "random") ? "random" : "daily";
      category.value = ["any","food","social","help","negotiation","weird","career"].includes(decoded.fCat) ? decoded.fCat : "any";
      difficulty.value = String(Math.min(5, Math.max(1, parseInt(decoded.fDiff || 3, 10) || 3)));

      current = {cat: decoded.cat, diff: decoded.diff, text: decoded.text};
      challengeText.textContent = decoded.text;
      shareText.textContent = decoded.text;
    }
  }

  // Init
  syncMeta();
  setMode(mode);
  render();
  showModal();
})();
</script>
</body>
</html>

